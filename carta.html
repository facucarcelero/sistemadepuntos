<!DOCTYPE html>
<!-- Cambio sin valor alguno -->
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menú Los Nogales</title>
    <link rel="icon" type="image/x-icon" href="./Logo/favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/phosphor-icons@1.4.2/src/css/icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js@1.12.0/src/toastify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --primary-blue: #3b82f6;
            --primary-green: #10b981;
            --primary-red: #ef4444;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --bg-primary: #ffffff;
            --bg-secondary: #f9fafb;
            --border-color: #e5e7eb;
            --background-color: #f5f5f5;
            --container-bg: #ffffff;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--background-color);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .main-container { 
            max-width: 900px; 
            margin: auto; 
            background: var(--container-bg); 
            padding: 30px 40px 40px; 
            border-radius: 24px; 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); 
            position: relative; 
            z-index: 1; 
        }
        .menu-header { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            padding-bottom: 25px; 
            border-bottom: 2px solid var(--border-color); 
            margin-bottom: 30px; 
            position: relative; 
        }
        .header-title-group { 
            display: flex; 
            align-items: center; 
            gap: 20px; 
            position: relative;
            z-index: 10;
        }
        .header-logo { 
            height: 60px; 
            width: auto; 
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }
        .menu-header h1 { 
            color: var(--text-primary); 
            font-size: 2.5em; 
            font-weight: 700; 
            margin: 0; 
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
            z-index: 10;
        }
        .hidden { display: none; }
        #public-view .menu-category h2 { font-size: 1.8em; color: var(--text-primary); border-bottom: 2px solid var(--primary-green); padding-bottom: 10px; margin-bottom: 20px; }
        #public-view .menu-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
            gap: 15px; 
            padding: 20px; 
            margin-bottom: 15px; 
            border-radius: 16px; 
            background: var(--bg-primary); 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); 
            border: 1px solid var(--border-color); 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        
        #public-view .menu-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        #public-view .menu-item-content { display: flex; flex-direction: column; flex: 1; }
        #public-view .menu-item-price { 
            font-weight: 700; 
            font-size: 1.1em; 
            background: linear-gradient(135deg, var(--primary-green), #059669);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        #public-view .menu-category > div:last-of-type { border-bottom: none; }
        #public-view .menu-item-name { font-weight: 600; }
        #public-view .menu-item-description { font-style: italic; color: #6c757d; font-size: 0.9em; margin-top: 4px; }
        
        /* Mejoras para la vista pública */
        .print-button { 
            position: fixed; 
            bottom: 20px; 
            right: 20px; 
            background: linear-gradient(135deg, var(--primary-blue), #1d4ed8); 
            color: white; 
            border: none; 
            padding: 12px 20px; 
            border-radius: 50px; 
            font-weight: 600; 
            cursor: pointer; 
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3); 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            z-index: 1000; 
        }
        
        .print-button:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 15px 35px rgba(59, 130, 246, 0.4); 
        }
        
        /* Estilos para impresión */
        @media print {
            .print-button, #show-admin-button, #back-button { display: none !important; }
            body { padding: 0; }
            .main-container { box-shadow: none; border-radius: 0; }
            .menu-header { border-bottom: 2px solid #000; }
        }
        
        /* Mejoras de animación */
        .menu-item { transition: all 0.3s ease; }
        .menu-item:hover { transform: translateX(5px); }
        
        /* Indicadores especiales */
        .premium-indicator {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #8b4513;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            box-shadow: 0 2px 8px rgba(251, 191, 36, 0.3); 
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); 
        }
        
        /* Removemos el ::before que agregaba una estrella extra */
        /* .premium-indicator::before {
            content: '⭐';
            font-size: 0.9em;
        } */
        
        /* Botón premium en admin */
        .btn-icon.premium-active {
            background-color: #ffd700 !important;
            color: #8b4513 !important;
        }
        .btn-icon.premium-active:hover {
            background-color: #ffed4e !important;
        }
        #admin-view { display: none; }
        .admin-top-bar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        .admin-top-bar h3 { margin: 0; font-weight: 600; }
        .btn-icon { background: transparent; border: none; cursor: pointer; padding: 8px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background-color 0.3s; }
        .btn-icon:hover { background-color: var(--light-gray); }
        .btn-icon svg { width: 24px; height: 24px; fill: var(--text-color); }
        #admin-view .admin-controls { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; background-color: var(--light-gray); padding: 15px; border-radius: 8px; }
        #admin-view .search-filters { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; background-color: var(--light-gray); padding: 15px; border-radius: 8px; }
        #admin-view .menu-category { border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; margin-bottom: 20px; transition: opacity 0.3s; background-color: #fff; }
        #admin-view.hide-hidden-items .is-hidden { display: none; }
        .draggable-handle { cursor: grab; color: #adb5bd; }
        .sortable-ghost { background-color: #d1fae5; opacity: 0.7; }
        #admin-view .menu-category.is-hidden, #admin-view .menu-item.is-hidden { opacity: 0.5; background-color: #f8f9fa; }
        
        /* Modo oscuro - Pantalla completa */
        body.dark-mode { 
            background-color: #1a1a1a !important; 
            color: #ffffff !important; 
        }
        
        body.dark-mode .main-container { 
            background: #2d2d2d !important; 
            box-shadow: 0 6px 20px rgba(255, 255, 255, 0.1) !important; 
            color: #ffffff !important;
        }
        
        body.dark-mode .menu-header { 
            border-bottom-color: #404040 !important; 
        }
        
        body.dark-mode .menu-header h1 { 
            color: #ffffff !important; 
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3) !important;
        }
        
        body.dark-mode #public-view .menu-category h2 { 
            color: #ffffff !important; 
            border-bottom-color: #28a745 !important; 
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3) !important;
        }
        
        body.dark-mode #public-view .menu-item { 
            border-bottom-color: #404040 !important; 
            transition: all 0.3s ease !important;
            background: #3a3a3a !important;
            color: #ffffff !important;
        }
        
        body.dark-mode #public-view .menu-item:hover { 
            background-color: rgba(255, 255, 255, 0.05) !important; 
            transform: translateX(5px) !important;
            background: #404040 !important;
        }
        
        body.dark-mode #public-view .menu-item-description { 
            color: #b0b0b0 !important; 
        }
        
        body.dark-mode #public-view .menu-item-price { 
            color: #28a745 !important; 
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3) !important;
        }
        
        /* Mejoras adicionales para el modo oscuro en vista pública */
        body.dark-mode .premium-indicator { 
            background: linear-gradient(45deg, #ffd700, #ffed4e) !important; 
            color: #8b4513 !important; 
            box-shadow: 0 2px 4px rgba(255, 215, 0, 0.3) !important;
        }
        
        body.dark-mode .print-button { 
            background: linear-gradient(135deg, #28a745, #20c997) !important; 
            color: white !important; 
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4) !important;
        }
        
        body.dark-mode .print-button:hover { 
            background: linear-gradient(135deg, #20c997, #28a745) !important; 
            box-shadow: 0 6px 16px rgba(40, 167, 69, 0.6) !important;
        }
        
        /* Estilos para el botón de cambio de tema en modo oscuro */
        body.dark-mode #toggle-theme-button { 
            background: #2d2d2d !important; 
            color: #ffffff !important; 
        }
        
        body.dark-mode #toggle-theme-button:hover { 
            background: #404040 !important; 
        }
        
        /* Estilos para el footer en modo oscuro */
        body.dark-mode .footer-info { 
            background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%) !important; 
            border-color: #404040 !important; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
        }
        
        body.dark-mode .footer-info p[style*="color: #6c757d"] { 
            color: #b0b0b0 !important; 
        }
        
        body.dark-mode .footer-info p[style*="color: #adb5bd"] { 
            color: #808080 !important; 
        }
        
        body.dark-mode #admin-view { 
            color: #ffffff !important; 
        }
        
        body.dark-mode #admin-view .menu-category { 
            background-color: #2d2d2d !important; 
            border-color: #404040 !important; 
        }
        
        body.dark-mode #admin-view .admin-controls, 
        body.dark-mode #admin-view .search-filters { 
            background-color: #333333 !important; 
        }
        
        body.dark-mode #admin-view input, 
        body.dark-mode #admin-view textarea,
        body.dark-mode #admin-view select { 
            background-color: #404040 !important; 
            color: #ffffff !important; 
            border-color: #555555 !important; 
        }
        
        body.dark-mode #admin-view .btn { 
            background-color: #404040 !important; 
            color: #ffffff !important; 
        }
        
        body.dark-mode #admin-view .btn-green { 
            background-color: #28a745 !important; 
        }
        
        body.dark-mode #admin-view .btn-red { 
            background-color: #dc3545 !important; 
        }
        
        body.dark-mode #admin-view .btn-blue { 
            background-color: #007bff !important; 
        }
        
        /* Estilos específicos para elementos select en modo oscuro */
        body.dark-mode #admin-view select { 
            background-color: #404040 !important; 
            color: #ffffff !important; 
            border-color: #555555 !important; 
        }
        
        body.dark-mode #admin-view select:focus { 
            background-color: #505050 !important; 
            border-color: #28a745 !important; 
            outline: none !important; 
        }
        
        body.dark-mode #admin-view select:hover { 
            background-color: #505050 !important; 
        }
        
        body.dark-mode #admin-view select option { 
            background-color: #404040 !important; 
            color: #ffffff !important; 
        }
        
        body.dark-mode #admin-view select option:hover { 
            background-color: #28a745 !important; 
        }
        
        body.dark-mode .stat-card { 
            background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%) !important;
            color: #ffffff !important;
            border-color: #4a4a4a !important;
        }
        
        body.dark-mode .stat-card:hover {
            background: linear-gradient(135deg, #3a3a3a 0%, #2d2d2d 100%) !important;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2) !important;
        }
        
        body.dark-mode .stat-number {
            background: linear-gradient(135deg, #60a5fa, #3b82f6) !important;
            -webkit-background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
            background-clip: text !important;
        }
        
        body.dark-mode .stat-label {
            color: #cccccc !important;
        }
        
        /* Estilos para los botones del admin-top-bar en modo oscuro */
        body.dark-mode .admin-top-bar button {
            background-color: #404040 !important;
            color: #ffffff !important;
            border: 1px solid #555555 !important;
        }
        
        body.dark-mode .admin-top-bar button:hover {
            background-color: #505050 !important;
            border-color: #28a745 !important;
        }
        
        /* Estilos específicos para el botón de exportar en modo oscuro */
        body.dark-mode .admin-top-bar button[onclick*="exportMenu"] {
            background-color: #1e40af !important;
            color: #ffffff !important;
        }
        
        body.dark-mode .admin-top-bar button[onclick*="exportMenu"]:hover {
            background-color: #1d4ed8 !important;
        }
        
        body.dark-mode .admin-top-bar button[onclick*="exportToPDF"] {
            background-color: #059669 !important;
            color: #ffffff !important;
        }
        
        body.dark-mode .admin-top-bar button[onclick*="exportToPDF"]:hover {
            background-color: #047857 !important;
        }
        
        /* Estilos para botones de modal en modo oscuro */
        body.dark-mode #close-admin-modal-button {
            background-color: #404040 !important;
            color: #ffffff !important;
            border: 1px solid #555555 !important;
        }
        
        body.dark-mode #close-admin-modal-button:hover {
            background-color: #505050 !important;
            border-color: #dc3545 !important;
        }
        
        body.dark-mode .btn-icon:hover { 
            background-color: #404040 !important; 
        }
        
        body.dark-mode .draggable-handle { 
            color: #808080 !important; 
        }
        
        body.dark-mode .sortable-ghost { 
            background-color: #1a3a1a !important; 
        }
        
        body.dark-mode #admin-view .menu-category.is-hidden, 
        body.dark-mode #admin-view .menu-item.is-hidden { 
            opacity: 0.5; 
            background-color: #1a1a1a !important; 
        }
        
        /* Mejoras adicionales para móviles */
        @media (max-width: 480px) {
            body.dark-mode .main-container { 
                margin: 0; 
                border-radius: 0; 
                min-height: 100vh; 
            }
            
            body.dark-mode .print-button { 
                background: #28a745 !important; 
                color: white !important; 
            }
            
            body.dark-mode #back-button,
            body.dark-mode #show-admin-button,
            body.dark-mode #toggle-theme-button { 
                background: #2d2d2d !important; 
                color: #ffffff !important; 
            }
            
            body.dark-mode #back-button:hover,
            body.dark-mode #show-admin-button:hover,
            body.dark-mode #toggle-theme-button:hover { 
                background: #404040 !important; 
            }
            
            /* Ajustar posición de botones en móvil - subirlos un poco */
            .menu-header .absolute {
                top: -8px !important;
            }
            
            /* Asegurar que los precios se vean bien en modo oscuro en móvil */
            body.dark-mode #public-view .menu-item-price {
                color: #28a745 !important;
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3) !important;
            }
        }
        
        /* Mejoras para tablets */
        @media (min-width: 481px) and (max-width: 1023px) {
            body.dark-mode .main-container { 
                margin: 10px auto; 
            }
        }
        
        /* Transiciones suaves para el modo oscuro */
        body, .main-container, .menu-header, #public-view, #admin-view,
        .menu-category, .menu-item, .btn, input, textarea, select {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        
        /* Mejoras para el logo en modo oscuro */
        body.dark-mode .header-logo {
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5))
                    drop-shadow(0 0 8px rgba(255,255,255,0.2))
                    brightness(1.2)
                    contrast(1.1);
        }
        
        /* Estilos base para elementos select en modo claro */
        #admin-view select { 
            background-color: #ffffff; 
            color: #212529; 
            border: 1px solid #dee2e6; 
            border-radius: 4px; 
            padding: 8px 12px; 
            font-size: 14px; 
            transition: all 0.3s ease; 
        }
        
        #admin-view select:focus { 
            background-color: #ffffff; 
            border-color: #28a745; 
            outline: none; 
            box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.25); 
        }
        
        #admin-view select:hover { 
            border-color: #28a745; 
        }
        
        /* Toast notifications */
        .toast-success { background: linear-gradient(to right, #28a745, #20c997); }
        .toast-error { background: linear-gradient(to right, #dc3545, #e74c3c); }
        .toast-info { background: linear-gradient(to right, #007bff, #17a2b8); }
        
        /* Loading indicators */
        .loading-spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Image preview */
        .image-preview { max-width: 100px; max-height: 100px; border-radius: 8px; object-fit: cover; }
        .image-upload { border: 2px dashed #ccc; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: border-color 0.3s; }
        .image-upload:hover { border-color: #007bff; }
        
        /* Rich text editor */
        .rich-editor { border: 1px solid #ccc; border-radius: 8px; overflow: hidden; }
        .rich-editor-toolbar { background-color: #f8f9fa; padding: 10px; border-bottom: 1px solid #ccc; }
        .rich-editor-content { min-height: 100px; padding: 15px; background-color: white; }
        
        /* Statistics dashboard */
        .stats-dashboard { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; 
            margin-bottom: 20px; 
        }
        
        .stat-card { 
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 25px; 
            border-radius: 16px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            text-align: center; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid #e5e7eb;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s;
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .stat-card:hover::before {
            left: 100%;
        }
        
        .stat-number { 
            font-size: 2.5em; 
            font-weight: 700; 
            background: linear-gradient(135deg, var(--primary-blue), #1d4ed8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
            display: block;
        }
        
        .stat-label { 
            color: var(--text-secondary); 
            margin-top: 5px; 
            font-weight: 500;
            font-size: 0.95em;
        }
        
        #admin-view .category-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-wrap: wrap; 
            gap: 10px; 
            margin-bottom: 15px; 
        }
        
        #admin-view .category-header input { 
            font-size: 1.5em; 
            font-weight: 700; 
            border: none; 
            background: transparent; 
            padding: 5px; 
            border-bottom: 2px solid transparent; 
            flex-grow: 1; 
        }
        
        #admin-view .menu-item { 
            display: grid; 
            grid-template-columns: auto 1fr auto; 
            gap: 15px; 
            align-items: flex-start; 
            padding-top: 15px; 
            margin-top: 15px; 
            border-top: 1px solid var(--border-color); 
            transition: opacity 0.3s; 
        }
        
        #admin-view .menu-item-inputs { 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
        }
        
        #admin-view .menu-item-inputs input, 
        #admin-view .menu-item-inputs textarea { 
            width: 100%; 
            padding: 8px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            font-size: 14px; 
        }
        
        #admin-view .menu-item-inputs textarea { 
            font-family: inherit; 
            resize: none; 
            overflow: hidden; 
            min-height: 60px; 
            max-height: 200px; 
            transition: height 0.2s ease;
        }
        
        #admin-view .menu-item-actions { 
            display: flex; 
            align-items: flex-start; 
            gap: 10px; 
        }
        
        input, .btn { 
            border-radius: 8px; 
            border: 1px solid var(--border-color); 
            padding: 10px; 
            font-size: 1em; 
            box-sizing: border-box; 
            width: 100%; 
        }
        
        .btn { 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s; 
            white-space: nowrap; 
            border: none; 
        }
        
        .btn-green { 
            background-color: var(--primary-green); 
            color: white; 
        }
        
        .btn-red { 
            background-color: var(--primary-red); 
            color: white; 
        }
        
        .btn-blue { 
            background-color: var(--primary-blue); 
            color: white; 
        }
        
        /* Responsive Design - Mobile First Approach */
        
        /* Móviles pequeños (≤480px) */
        @media (max-width: 480px) {
            body { 
                padding: 8px; 
                padding-bottom: 100px; 
            }
            .main-container { 
                padding: 12px; 
                border-radius: 8px; 
                margin: 0;
            }
            .menu-header .header-title-group { 
                gap: 8px; 
                flex-direction: column; 
                text-align: center; 
            }
            .header-logo { 
                height: 120px; 
            }
            .menu-header h1 { 
                font-size: 1.3em; 
            }
            #public-view .menu-item { 
                flex-direction: row; 
                align-items: flex-start; 
                gap: 10px; 
            }
            #public-view .menu-item-content { 
                flex: 1; 
                min-width: 0; 
            }
            #public-view .menu-item-price { 
                font-size: 1em; 
                margin-left: 8px; 
                flex-shrink: 0; 
            }
            #admin-view .admin-controls, 
            #admin-view .search-filters { 
                flex-direction: column; 
                gap: 8px; 
            }
            #admin-view .category-header { 
                flex-direction: column; 
                gap: 10px; 
            }
            #admin-view .category-header .category-actions { 
                display: flex; 
                gap: 5px; 
                flex-wrap: wrap; 
            }
            #admin-view .menu-item { 
                grid-template-columns: 1fr; 
                gap: 10px; 
            }
            #admin-view .menu-item-actions { 
                justify-content: flex-start; 
                flex-wrap: wrap; 
            }
            #admin-view .menu-item-actions input { 
                max-width: 100px; 
            }
            .stats-dashboard { 
                grid-template-columns: 1fr; 
                gap: 10px; 
            }
            .print-button { 
                width: 50px; 
                height: 50px; 
                font-size: 20px; 
                bottom: 15px; 
                right: 15px; 
            }
            .admin-top-bar { 
                flex-direction: column; 
                gap: 10px; 
                align-items: stretch; 
            }
            .admin-top-bar > div { 
                justify-content: center; 
            }
            .footer-info {
                padding: 15px;
                font-size: 0.8em;
            }
        }
        
        /* Tablets pequeñas (481px - 767px) */
        @media (min-width: 481px) and (max-width: 767px) {
            body { 
                padding: 10px; 
                padding-bottom: 100px; 
            }
            .main-container { 
                padding: 15px; 
            }
            .menu-header .header-title-group { 
                gap: 10px; 
            }
            .header-logo { 
                height: 85px; 
            }
            .menu-header h1 { 
                font-size: 1.5em; 
            }
            #public-view .menu-item { 
                flex-direction: column; 
                align-items: flex-start; 
                gap: 5px; 
            }
            #admin-view .admin-controls, 
            #admin-view .search-filters { 
                flex-direction: column; 
                gap: 10px; 
            }
            #admin-view .category-header { 
                flex-direction: column; 
                gap: 10px; 
            }
            #admin-view .category-header .category-actions { 
                display: flex; 
                gap: 10px; 
            }
            #admin-view .menu-item { 
                grid-template-columns: 1fr; 
            }
            #admin-view .menu-item-actions { 
                justify-content: flex-start; 
            }
            #admin-view .menu-item-actions input { 
                max-width: 120px; 
            }
            .stats-dashboard { 
                grid-template-columns: repeat(2, 1fr); 
                gap: 15px; 
            }
        }
        
        /* Tablets grandes (768px - 1023px) */
        @media (min-width: 768px) and (max-width: 1023px) {
            .main-container { 
                max-width: 800px; 
                padding: 25px; 
            }
            .stats-dashboard { 
                grid-template-columns: repeat(3, 1fr); 
                gap: 20px; 
            }
            #admin-view .menu-item { 
                grid-template-columns: auto 1fr auto; 
            }
            .header-logo { 
                height: 100px; 
            }
            .menu-header h1 { 
                font-size: 2em; 
            }
        }
        
        /* Pantallas medianas (1024px - 1439px) */
        @media (min-width: 1024px) and (max-width: 1439px) {
            .main-container { 
                max-width: 1000px; 
                padding: 30px; 
            }
            .stats-dashboard { 
                grid-template-columns: repeat(4, 1fr); 
                gap: 20px; 
            }
            #admin-view .menu-item { 
                grid-template-columns: auto 1fr auto; 
            }
            .header-logo { 
                height: 120px; 
            }
            .menu-header h1 { 
                font-size: 2.5em; 
            }
        }
        
        /* Pantallas grandes (1440px - 1919px) */
        @media (min-width: 1440px) and (max-width: 1919px) {
            .main-container { 
                max-width: 1200px; 
                padding: 35px; 
            }
            .stats-dashboard { 
                grid-template-columns: repeat(5, 1fr); 
                gap: 25px; 
            }
            .menu-header h1 { 
                font-size: 3em; 
            }
            .header-logo { 
                height: 140px; 
            }
        }
        
        /* Pantallas ultra-wide (≥1920px) */
        @media (min-width: 1920px) {
            .main-container { 
                max-width: 1400px; 
                padding: 40px; 
            }
            .stats-dashboard { 
                grid-template-columns: repeat(6, 1fr); 
                gap: 30px; 
            }
            .menu-header h1 { 
                font-size: 3.5em; 
            }
            .header-logo { 
                height: 160px; 
            }
            #public-view .menu-category h2 {
                font-size: 2.2em;
            }
            #public-view .menu-item-name {
                font-size: 1.2em;
            }
            #public-view .menu-item-price {
                font-size: 1.3em;
            }
        }
        
        /* Orientación landscape en móviles */
        @media (max-width: 768px) and (orientation: landscape) {
            body {
                padding: 5px;
            }
            .main-container {
                padding: 10px;
            }
            .menu-header .header-title-group {
                flex-direction: row;
                gap: 15px;
            }
            .header-logo {
                height: 30px;
            }
            .menu-header h1 {
                font-size: 1.2em;
            }
        }
        
        /* Estilos adicionales para modo oscuro */
        body.dark-mode * {
            color: inherit;
        }
        
        body.dark-mode .menu-header h1,
        body.dark-mode .menu-header h2,
        body.dark-mode .menu-header h3,
        body.dark-mode .menu-header h4,
        body.dark-mode .menu-header h5,
        body.dark-mode .menu-header h6 {
            color: #ffffff !important;
        }
        
        body.dark-mode #public-view .menu-item-name,
        body.dark-mode #public-view .menu-item-description,
        body.dark-mode #public-view .menu-item-price {
            color: #ffffff !important;
        }
        
        body.dark-mode #public-view .menu-item-description {
            color: #cccccc !important;
        }
        
        body.dark-mode #public-view .menu-item-price {
            color: var(--primary-green) !important;
        }
        
        body.dark-mode .admin-controls input,
        body.dark-mode .admin-controls textarea,
        body.dark-mode .admin-controls select {
            background: #3a3a3a !important;
            color: #ffffff !important;
            border-color: #4a4a4a !important;
        }
        
        body.dark-mode .category-header input {
            background: #3a3a3a !important;
            color: #ffffff !important;
            border-color: #4a4a4a !important;
        }
        
        body.dark-mode .menu-item-admin input,
        body.dark-mode .menu-item-admin textarea {
            background: #3a3a3a !important;
            color: #ffffff !important;
            border-color: #4a4a4a !important;
        }
        
        body.dark-mode .btn i,
        body.dark-mode .btn-icon i,
        body.dark-mode .header-btn i {
            color: #ffffff !important;
        }
        
        body.dark-mode .btn-icon {
            color: #ffffff !important;
        }
        
        body.dark-mode .header-btn {
            color: #ffffff !important;
        }
        
        /* Estilos para el modal de login en modo oscuro */
        body.dark-mode #admin-login-modal .bg-white {
            background: #2d2d2d !important;
            color: #ffffff !important;
        }
        
        body.dark-mode #admin-login-modal h3 {
            color: #ffffff !important;
        }
        
        body.dark-mode #admin-login-modal input {
            background: #3a3a3a !important;
            color: #ffffff !important;
            border-color: #4a4a4a !important;
        }
        
        body.dark-mode #admin-login-modal input::placeholder {
            color: #cccccc !important;
        }
        
        body.dark-mode #admin-login-modal #toggle-password {
            color: #cccccc !important;
        }
        
        body.dark-mode #admin-login-modal #toggle-password:hover {
            color: #ffffff !important;
        }
        
        body.dark-mode #admin-login-modal #close-admin-modal-button {
            background: #4a4a4a !important;
            color: #ffffff !important;
        }
        
        body.dark-mode #admin-login-modal #close-admin-modal-button:hover {
            background: #5a5a5a !important;
        }
        
        body.dark-mode .header-btn {
            color: #ffffff !important;
        }
        
        /* Arreglar botones específicos en modo oscuro */
        body.dark-mode #admin-button,
        body.dark-mode #back-button,
        body.dark-mode .admin-button,
        body.dark-mode .back-button {
            background: #3a3a3a !important;
            color: #ffffff !important;
            border-color: #4a4a4a !important;
        }
        
        body.dark-mode #admin-button:hover,
        body.dark-mode #back-button:hover,
        body.dark-mode .admin-button:hover,
        body.dark-mode .back-button:hover {
            background: #404040 !important;
        }
        
        /* Arreglar fondo del header en modo oscuro */
        body.dark-mode .admin-header,
        body.dark-mode .header-bar {
            background: #2d2d2d !important;
            color: #ffffff !important;
        }
        
        /* Arreglar cualquier elemento con fondo negro */
        body.dark-mode .bg-black,
        body.dark-mode [class*="bg-black"] {
            background: #2d2d2d !important;
        }
        
        body.dark-mode .text-black,
        body.dark-mode [class*="text-black"] {
            color: #ffffff !important;
        }
        
        /* Estilos más específicos para botones en modo oscuro */
        body.dark-mode button#show-admin-button,
        body.dark-mode button#back-button,
        body.dark-mode button#toggle-theme-button {
            background: #3a3a3a !important;
            color: #ffffff !important;
            border: 1px solid #4a4a4a !important;
        }
        
        body.dark-mode button#show-admin-button:hover,
        body.dark-mode button#back-button:hover,
        body.dark-mode button#toggle-theme-button:hover {
            background: #404040 !important;
        }
        
        body.dark-mode button#show-admin-button i,
        body.dark-mode button#back-button i,
        body.dark-mode button#toggle-theme-button i {
            color: #ffffff !important;
        }
        
        /* Sobrescribir clases bg-white en modo oscuro */
        body.dark-mode .bg-white {
            background: #2d2d2d !important;
        }
        
        body.dark-mode button.bg-white {
            background: #3a3a3a !important;
        }
        
        body.dark-mode .text-gray-600 {
            color: #ffffff !important;
        }
        
        body.dark-mode button.text-gray-600 {
            color: #ffffff !important;
        }
        
        /* Asegurar que no haya bordes negros en modo oscuro */
        body.dark-mode * {
            border-color: #4a4a4a !important;
        }
        
        body.dark-mode .menu-header {
            border-bottom-color: #4a4a4a !important;
        }
        
        body.dark-mode .menu-category h2 {
            border-bottom-color: var(--primary-green) !important;
        }
        
        /* Estilos para descuentos en modo oscuro */
        body.dark-mode .menu-item-price span[style*="text-decoration: line-through"] {
            color: #666 !important;
        }
        
        body.dark-mode .menu-item-price span[style*="color: #e53e3e"] {
            color: #f56565 !important;
        }
        
        body.dark-mode .menu-item-price span[style*="background: #e53e3e"] {
            background: #f56565 !important;
            color: #ffffff !important;
        }
        
        /* Estilos para botones de modal en modo oscuro */
        body.dark-mode .btn-icon:hover { 
            background-color: #404040 !important; 
        }
        
        body.dark-mode .draggable-handle { 
            color: #808080 !important; 
        }
        
        body.dark-mode .sortable-ghost { 
            background-color: #1a3a1a !important; 
        }
        
        body.dark-mode #admin-view .menu-category.is-hidden, 
        body.dark-mode #admin-view .menu-item.is-hidden { 
            opacity: 0.5; 
            background-color: #1a1a1a !important; 
        }
        
        /* Mejoras adicionales para móviles */
        @media (max-width: 480px) {
            body.dark-mode .main-container { 
                margin: 0; 
                border-radius: 0; 
                min-height: 100vh; 
            }
            
            body.dark-mode .print-button { 
                background: #28a745 !important; 
                color: white !important; 
            }
            
            body.dark-mode #back-button,
            body.dark-mode #show-admin-button,
            body.dark-mode #toggle-theme-button { 
                background: #2d2d2d !important; 
                color: #ffffff !important; 
            }
            
            body.dark-mode #back-button:hover,
            body.dark-mode #show-admin-button:hover,
            body.dark-mode #toggle-theme-button:hover { 
                background: #404040 !important; 
            }
            
            /* Ajustar posición de botones en móvil - subirlos un poco */
            .menu-header .absolute {
                top: -8px !important;
            }
            
            /* Asegurar que los precios se vean bien en modo oscuro en móvil */
            body.dark-mode #public-view .menu-item-price {
                color: #28a745 !important;
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3) !important;
            }
        }
        
        /* Mejoras para tablets */
        @media (min-width: 481px) and (max-width: 1023px) {
            body.dark-mode .main-container { 
                margin: 10px auto; 
            }
        }
        
        /* Transiciones suaves para el modo oscuro */
        body, .main-container, .menu-header, #public-view, #admin-view,
        .menu-category, .menu-item, .btn, input, textarea, select {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        
        /* Mejoras para el logo en modo oscuro */
        body.dark-mode .header-logo {
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5))
                    drop-shadow(0 0 8px rgba(255,255,255,0.2))
                    brightness(1.2)
                    contrast(1.1);
        }
        
        /* Estilos base para elementos select en modo claro */
        #admin-view select { 
            background-color: #ffffff; 
            color: #212529; 
            border: 1px solid #dee2e6; 
            border-radius: 4px; 
            padding: 8px 12px; 
            font-size: 14px; 
            transition: all 0.3s ease; 
        }
        
        #admin-view select:focus { 
            background-color: #ffffff; 
            border-color: #28a745; 
            outline: none; 
            box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.25); 
        }
        
        #admin-view select:hover { 
            border-color: #28a745; 
        }
        
        /* Toast notifications */
        .toast-success { background: linear-gradient(to right, #28a745, #20c997); }
        .toast-error { background: linear-gradient(to right, #dc3545, #e74c3c); }
        .toast-info { background: linear-gradient(to right, #007bff, #17a2b8); }
        
        /* Loading indicators */
        .loading-spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Image preview */
        .image-preview { max-width: 100px; max-height: 100px; border-radius: 8px; object-fit: cover; }
        .image-upload { border: 2px dashed #ccc; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: border-color 0.3s; }
        .image-upload:hover { border-color: #007bff; }
        
        /* Rich text editor */
        .rich-editor { border: 1px solid #ccc; border-radius: 8px; overflow: hidden; }
        .rich-editor-toolbar { background-color: #f8f9fa; padding: 10px; border-bottom: 1px solid #ccc; }
        .rich-editor-content { min-height: 100px; padding: 15px; background-color: white; }
        
        /* Statistics dashboard */
        .stats-dashboard { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; 
            margin-bottom: 20px; 
        }
        
        .stat-card { 
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 25px; 
            border-radius: 16px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            text-align: center; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid #e5e7eb;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s;
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .stat-card:hover::before {
            left: 100%;
        }
        
        .stat-number { 
            font-size: 2.5em; 
            font-weight: 700; 
            background: linear-gradient(135deg, var(--primary-blue), #1d4ed8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
            display: block;
        }
        
        .stat-label { 
            color: var(--text-secondary); 
            margin-top: 5px; 
            font-weight: 500;
            font-size: 0.95em;
        }
        
        #admin-view .category-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-wrap: wrap; 
            gap: 10px; 
            margin-bottom: 15px; 
        }
        
        #admin-view .category-header input { 
            font-size: 1.5em; 
            font-weight: 700; 
            border: none; 
            background: transparent; 
            padding: 5px; 
            border-bottom: 2px solid transparent; 
            flex-grow: 1; 
        }
        
        #admin-view .menu-item { 
            display: grid; 
            grid-template-columns: auto 1fr auto; 
            gap: 15px; 
            align-items: flex-start; 
            padding-top: 15px; 
            margin-top: 15px; 
            border-top: 1px solid var(--border-color); 
            transition: opacity 0.3s; 
        }
        
        #admin-view .menu-item-inputs { 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
        }
        
        #admin-view .menu-item-inputs input, 
        #admin-view .menu-item-inputs textarea { 
            width: 100%; 
            padding: 8px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            font-size: 14px; 
        }
        
        #admin-view .menu-item-inputs textarea { 
            font-family: inherit; 
            resize: none; 
            overflow: hidden; 
            min-height: 60px; 
            max-height: 200px; 
            transition: height 0.2s ease;
        }
        
        #admin-view .menu-item-actions { 
            display: flex; 
            align-items: flex-start; 
            gap: 10px; 
        }
        
        input, .btn { 
            border-radius: 8px; 
            border: 1px solid var(--border-color); 
            padding: 10px; 
            font-size: 1em; 
            box-sizing: border-box; 
            width: 100%; 
        }
        
        .btn { 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s; 
            white-space: nowrap; 
            border: none; 
        }
        
        .btn-green { 
            background-color: var(--primary-green); 
            color: white; 
        }
        
        .btn-red { 
            background-color: var(--primary-red); 
            color: white; 
        }
        
        .btn-blue { 
            background-color: var(--primary-blue); 
            color: white; 
        }
        
        /* Responsive Design - Mobile First Approach */
        
        /* Móviles pequeños (≤480px) */
        @media (max-width: 480px) {
            body { 
                padding: 8px; 
                padding-bottom: 100px; 
            }
            .main-container { 
                padding: 12px; 
                border-radius: 8px; 
                margin: 0;
            }
            .menu-header .header-title-group { 
                gap: 8px; 
                flex-direction: column; 
                text-align: center; 
            }
            .header-logo { 
                height: 120px; 
            }
            .menu-header h1 { 
                font-size: 1.3em; 
            }
            #public-view .menu-item { 
                flex-direction: row; 
                align-items: flex-start; 
                gap: 10px; 
            }
            #public-view .menu-item-content { 
                flex: 1; 
                min-width: 0; 
            }
            #public-view .menu-item-price { 
                font-size: 1em; 
                margin-left: 8px; 
                flex-shrink: 0; 
            }
            #admin-view .admin-controls, 
            #admin-view .search-filters { 
                flex-direction: column; 
                gap: 8px; 
            }
            #admin-view .category-header { 
                flex-direction: column; 
                gap: 10px; 
            }
            #admin-view .category-header .category-actions { 
                display: flex; 
                gap: 5px; 
                flex-wrap: wrap; 
            }
            #admin-view .menu-item { 
                grid-template-columns: 1fr; 
                gap: 10px; 
            }
            #admin-view .menu-item-actions { 
                justify-content: flex-start; 
                flex-wrap: wrap; 
            }
            #admin-view .menu-item-actions input { 
                max-width: 100px; 
            }
            .stats-dashboard { 
                grid-template-columns: 1fr; 
                gap: 10px; 
            }
            .print-button { 
                width: 50px; 
                height: 50px; 
                font-size: 20px; 
                bottom: 15px; 
                right: 15px; 
            }
            .admin-top-bar { 
                flex-direction: column; 
                gap: 10px; 
                align-items: stretch; 
            }
            .admin-top-bar > div { 
                justify-content: center; 
            }
            .footer-info {
                padding: 15px;
                font-size: 0.8em;
            }
        }
        
        /* Tablets pequeñas (481px - 767px) */
        @media (min-width: 481px) and (max-width: 767px) {
            body { 
                padding: 10px; 
                padding-bottom: 100px; 
            }
            .main-container { 
                padding: 15px; 
            }
            .menu-header .header-title-group { 
                gap: 10px; 
            }
            .header-logo { 
                height: 85px; 
            }
            .menu-header h1 { 
                font-size: 1.5em; 
            }
            #public-view .menu-item { 
                flex-direction: column; 
                align-items: flex-start; 
                gap: 5px; 
            }
            #admin-view .admin-controls, 
            #admin-view .search-filters { 
                flex-direction: column; 
                gap: 10px; 
            }
            #admin-view .category-header { 
                flex-direction: column; 
                gap: 10px; 
            }
            #admin-view .category-header .category-actions { 
                display: flex; 
                gap: 10px; 
            }
            #admin-view .menu-item { 
                grid-template-columns: 1fr; 
            }
            #admin-view .menu-item-actions { 
                justify-content: flex-start; 
            }
            #admin-view .menu-item-actions input { 
                max-width: 120px; 
            }
            .stats-dashboard { 
                grid-template-columns: repeat(2, 1fr); 
                gap: 15px; 
            }
        }
        
        /* Tablets grandes (768px - 1023px) */
        @media (min-width: 768px) and (max-width: 1023px) {
            .main-container { 
                max-width: 800px; 
                padding: 25px; 
            }
            .stats-dashboard { 
                grid-template-columns: repeat(3, 1fr); 
                gap: 20px; 
            }
            #admin-view .menu-item { 
                grid-template-columns: auto 1fr auto; 
            }
            .header-logo { 
                height: 100px; 
            }
            .menu-header h1 { 
                font-size: 2em; 
            }
        }
        
        /* Pantallas medianas (1024px - 1439px) */
        @media (min-width: 1024px) and (max-width: 1439px) {
            .main-container { 
                max-width: 1000px; 
                padding: 30px; 
            }
            .stats-dashboard { 
                grid-template-columns: repeat(4, 1fr); 
                gap: 20px; 
            }
            #admin-view .menu-item { 
                grid-template-columns: auto 1fr auto; 
            }
            .header-logo { 
                height: 120px; 
            }
            .menu-header h1 { 
                font-size: 2.5em; 
            }
        }
        
        /* Pantallas grandes (1440px - 1919px) */
        @media (min-width: 1440px) and (max-width: 1919px) {
            .main-container { 
                max-width: 1200px; 
                padding: 35px; 
            }
            .stats-dashboard { 
                grid-template-columns: repeat(5, 1fr); 
                gap: 25px; 
            }
            .menu-header h1 { 
                font-size: 3em; 
            }
            .header-logo { 
                height: 140px; 
            }
        }
        
        /* Pantallas ultra-wide (≥1920px) */
        @media (min-width: 1920px) {
            .main-container { 
                max-width: 1400px; 
                padding: 40px; 
            }
            .stats-dashboard { 
                grid-template-columns: repeat(6, 1fr); 
                gap: 30px; 
            }
            .menu-header h1 { 
                font-size: 3.5em; 
            }
            .header-logo { 
                height: 160px; 
            }
            #public-view .menu-category h2 {
                font-size: 2.2em;
            }
            #public-view .menu-item-name {
                font-size: 1.2em;
            }
            #public-view .menu-item-price {
                font-size: 1.3em;
            }
        }
        
        /* Orientación landscape en móviles */
        @media (max-width: 768px) and (orientation: landscape) {
            body {
                padding: 5px;
            }
            .main-container {
                padding: 10px;
            }
            .menu-header .header-title-group {
                flex-direction: row;
                gap: 15px;
            }
            .header-logo {
                height: 30px;
            }
            .menu-header h1 {
                font-size: 1.2em;
            }
        }
        
        /* Estilos adicionales para modo oscuro */
        body.dark-mode * {
            color: inherit;
        }
        
        body.dark-mode .menu-header h1,
        body.dark-mode .menu-header h2,
        body.dark-mode .menu-header h3,
        body.dark-mode .menu-header h4,
        body.dark-mode .menu-header h5,
        body.dark-mode .menu-header h6 {
            color: #ffffff !important;
        }
        
        body.dark-mode #public-view .menu-item-name,
        body.dark-mode #public-view .menu-item-description,
        body.dark-mode #public-view .menu-item-price {
            color: #ffffff !important;
        }
        
        body.dark-mode #public-view .menu-item-description {
            color: #cccccc !important;
        }
        
        body.dark-mode #public-view .menu-item-price {
            color: var(--primary-green) !important;
        }
        
        body.dark-mode .admin-controls input,
        body.dark-mode .admin-controls textarea,
        body.dark-mode .admin-controls select {
            background: #3a3a3a !important;
            color: #ffffff !important;
            border-color: #4a4a4a !important;
        }
        
        body.dark-mode .category-header input {
            background: #3a3a3a !important;
            color: #ffffff !important;
            border-color: #4a4a4a !important;
        }
        
        body.dark-mode .menu-item-admin input,
        body.dark-mode .menu-item-admin textarea {
            background: #3a3a3a !important;
            color: #ffffff !important;
            border-color: #4a4a4a !important;
        }
        
        body.dark-mode .btn i,
        body.dark-mode .btn-icon i,
        body.dark-mode .header-btn i {
            color: #ffffff !important;
        }
        
        body.dark-mode .btn-icon {
            color: #ffffff !important;
        }
        
        body.dark-mode .header-btn {
            color: #ffffff !important;
        }
        
        /* Estilos para el modal de login en modo oscuro */
        body.dark-mode #admin-login-modal .bg-white {
            background: #2d2d2d !important;
            color: #ffffff !important;
        }
        
        body.dark-mode #admin-login-modal h3 {
            color: #ffffff !important;
        }
        
        body.dark-mode #admin-login-modal input {
            background: #3a3a3a !important;
            color: #ffffff !important;
            border-color: #4a4a4a !important;
        }
        
        body.dark-mode #admin-login-modal input::placeholder {
            color: #cccccc !important;
        }
        
        body.dark-mode #admin-login-modal #toggle-password {
            color: #cccccc !important;
        }
        
        body.dark-mode #admin-login-modal #toggle-password:hover {
            color: #ffffff !important;
        }
        
        body.dark-mode #admin-login-modal #close-admin-modal-button {
            background: #4a4a4a !important;
            color: #ffffff !important;
        }
        
        body.dark-mode #admin-login-modal #close-admin-modal-button:hover {
            background: #5a5a5a !important;
        }
        
        body.dark-mode .header-btn {
            color: #ffffff !important;
        }
        
        /* Arreglar botones específicos en modo oscuro */
        body.dark-mode #admin-button,
        body.dark-mode #back-button,
        body.dark-mode .admin-button,
        body.dark-mode .back-button {
            background: #3a3a3a !important;
            color: #ffffff !important;
            border-color: #4a4a4a !important;
        }
        
        body.dark-mode #admin-button:hover,
        body.dark-mode #back-button:hover,
        body.dark-mode .admin-button:hover,
        body.dark-mode .back-button:hover {
            background: #404040 !important;
        }
        
        /* Arreglar fondo del header en modo oscuro */
        body.dark-mode .admin-header,
        body.dark-mode .header-bar {
            background: #2d2d2d !important;
            color: #ffffff !important;
        }
        
        /* Arreglar cualquier elemento con fondo negro */
        body.dark-mode .bg-black,
        body.dark-mode [class*="bg-black"] {
            background: #2d2d2d !important;
        }
        
        body.dark-mode .text-black,
        body.dark-mode [class*="text-black"] {
            color: #ffffff !important;
        }
        
        /* Estilos más específicos para botones en modo oscuro */
        body.dark-mode button#show-admin-button,
        body.dark-mode button#back-button,
        body.dark-mode button#toggle-theme-button {
            background: #3a3a3a !important;
            color: #ffffff !important;
            border: 1px solid #4a4a4a !important;
        }
        
        body.dark-mode button#show-admin-button:hover,
        body.dark-mode button#back-button:hover,
        body.dark-mode button#toggle-theme-button:hover {
            background: #404040 !important;
        }
        
        body.dark-mode button#show-admin-button i,
        body.dark-mode button#back-button i,
        body.dark-mode button#toggle-theme-button i {
            color: #ffffff !important;
        }
        
        /* Sobrescribir clases bg-white en modo oscuro */
        body.dark-mode .bg-white {
            background: #2d2d2d !important;
        }
        
        body.dark-mode button.bg-white {
            background: #3a3a3a !important;
        }
        
        body.dark-mode .text-gray-600 {
            color: #ffffff !important;
        }
        
        body.dark-mode button.text-gray-600 {
            color: #ffffff !important;
        }
        
        /* Asegurar que no haya bordes negros en modo oscuro */
        body.dark-mode * {
            border-color: #4a4a4a !important;
        }
        
        body.dark-mode .menu-header {
            border-bottom-color: #4a4a4a !important;
        }
        
        body.dark-mode .menu-category h2 {
            border-bottom-color: var(--primary-green) !important;
        }
        
        /* Estilos para descuentos en modo oscuro */
        body.dark-mode .menu-item-price span[style*="text-decoration: line-through"] {
            color: #666 !important;
        }
        
        body.dark-mode .menu-item-price span[style*="color: #e53e3e"] {
            color: #f56565 !important;
        }
        
        body.dark-mode .menu-item-price span[style*="background: #e53e3e"] {
            background: #f56565 !important;
            color: #ffffff !important;
        }
        
        /* Estilos para botones de modal en modo oscuro */
        body.dark-mode .btn-icon:hover { 
            background-color: #404040 !important; 
        }
        
        body.dark-mode .draggable-handle { 
            color: #808080 !important; 
        }
        
        body.dark-mode .sortable-ghost { 
            background-color: #1a3a1a !important; 
        }
        
        body.dark-mode #admin-view .menu-category.is-hidden, 
        body.dark-mode #admin-view .menu-item.is-hidden { 
            opacity: 0.5; 
            background-color: #1a1a1a !important; 
        }
        
        /* Mejoras adicionales para móviles */
        @media (max-width: 480px) {
            body.dark-mode .main-container { 
                margin: 0; 
                border-radius: 0; 
                min-height: 100vh; 
            }
            
            body.dark-mode .print-button { 
                background: #28a745 !important; 
                color: white !important; 
            }
            
            body.dark-mode #back-button,
            body.dark-mode #show-admin-button,
            body.dark-mode #toggle-theme-button { 
                background: #2d2d2d !important; 
                color: #ffffff !important; 
            }
            
            body.dark-mode #back-button:hover,
            body.dark-mode #show-admin-button:hover,
            body.dark-mode #toggle-theme-button:hover { 
                background: #404040 !important; 
            }
            
            /* Ajustar posición de botones en móvil - subirlos un poco */
            .menu-header .absolute {
                top: -8px !important;
            }
            
            /* Asegurar que los precios se vean bien en modo oscuro en móvil */
            body.dark-mode #public-view .menu-item-price {
                color: #28a745 !important;
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3) !important;
            }
        }
        
        /* Mejoras para tablets */
        @media (min-width: 481px) and (max-width: 1023px) {
            body.dark-mode .main-container { 
                margin: 10px auto; 
            }
        }
        
        /* Transiciones suaves para el modo oscuro */
        body, .main-container, .menu-header, #public-view, #admin-view,
        .menu-category, .menu-item, .btn, input, textarea, select {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        
        /* Mejoras para el logo en modo oscuro */
        body.dark-mode .header-logo {
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5))
                    drop-shadow(0 0 8px rgba(255,255,255,0.2))
                    brightness(1.2)
                    contrast(1.1);
        }
        
        /* Estilos base para elementos select en modo claro */
        #admin-view select { 
            background-color: #ffffff; 
            color: #212529; 
            border: 1px solid #dee2e6; 
            border-radius: 4px; 
            padding: 8px 12px; 
            font-size: 14px; 
            transition: all 0.3s ease; 
        }
        
        #admin-view select:focus { 
            background-color: #ffffff; 
            border-color: #28a745; 
            outline: none; 
            box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.25); 
        }
        
        #admin-view select:hover { 
            border-color: #28a745; 
        }
        
        /* Toast notifications */
        .toast-success { background: linear-gradient(to right, #28a745, #20c997); }
        .toast-error { background: linear-gradient(to right, #dc3545, #e74c3c); }
        .toast-info { background: linear-gradient(to right, #007bff, #17a2b8); }
        
        /* Loading indicators */
        .loading-spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Image preview */
        .image-preview { max-width: 100px; max-height: 100px; border-radius: 8px; object-fit: cover; }
        .image-upload { border: 2px dashed #ccc; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: border-color 0.3s; }
        .image-upload:hover { border-color: #007bff; }
        
        /* Rich text editor */
        .rich-editor { border: 1px solid #ccc; border-radius: 8px; overflow: hidden; }
        .rich-editor-toolbar { background-color: #f8f9fa; padding: 10px; border-bottom: 1px solid #ccc; }
        .rich-editor-content { min-height: 100px; padding: 15px; background-color: white; }
        
        /* Statistics dashboard */
        .stats-dashboard { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; 
            margin-bottom: 20px; 
        }
        
        .stat-card { 
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 25px; 
            border-radius: 16px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            text-align: center; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid #e5e7eb;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s;
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .stat-card:hover::before {
            left: 100%;
        }
        
        .stat-number { 
            font-size: 2.5em; 
            font-weight: 700; 
            background: linear-gradient(135deg, var(--primary-blue), #1d4ed8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
            display: block;
        }
        
        .stat-label { 
            color: var(--text-secondary); 
            margin-top: 5px; 
            font-weight: 500;
            font-size: 0.95em;
        }
        
        #admin-view .category-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-wrap: wrap; 
            gap: 10px; 
            margin-bottom: 15px; 
        }
        
        #admin-view .category-header input { 
            font-size: 1.5em; 
            font-weight: 700; 
            border: none; 
            background: transparent; 
            padding: 5px; 
            border-bottom: 2px solid transparent; 
            flex-grow: 1; 
        }
        
        #admin-view .menu-item { 
            display: grid; 
            grid-template-columns: auto 1fr auto; 
            gap: 15px; 
            align-items: flex-start; 
            padding-top: 15px; 
            margin-top: 15px; 
            border-top: 1px solid var(--border-color); 
            transition: opacity 0.3s; 
        }
        
        #admin-view .menu-item-inputs { 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
        }
        
        #admin-view .menu-item-inputs input, 
        #admin-view .menu-item-inputs textarea { 
            width: 100%; 
            padding: 8px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            font-size: 14px; 
        }
        
        #admin-view .menu-item-inputs textarea { 
            font-family: inherit; 
            resize: none; 
            overflow: hidden; 
            min-height: 60px; 
            max-height: 200px; 
            transition: height 0.2s ease;
        }
        
        #admin-view .menu-item-actions { 
            display: flex; 
            align-items: flex-start; 
            gap: 10px; 
        }
        
        input, .btn { 
            border-radius: 8px; 
            border: 1px solid var(--border-color); 
            padding: 10px; 
            font-size: 1em; 
            box-sizing: border-box; 
            width: 100%; 
        }
        
        .btn { 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s; 
            white-space: nowrap; 
            border: none; 
        }
        
        .btn-green { 
            background-color: var(--primary-green); 
            color: white; 
        }
        
        .btn-red { 
            background-color: var(--primary-red); 
            color: white; 
        }
        
        .btn-blue { 
            background-color: var(--primary-blue); 
            color: white; 
        }
        
        /* Responsive Design - Mobile First Approach */
        
        /* Móviles pequeños (≤480px) */
        @media (max-width: 480px) {
            body { 
                padding: 8px; 
                padding-bottom: 100px; 
            }
            .main-container { 
                padding: 12px; 
                border-radius: 8px; 
                margin: 0;
            }
            .menu-header .header-title-group { 
                gap: 8px; 
                flex-direction: column; 
                text-align: center; 
            }
            .header-logo { 
                height: 120px; 
            }
            .menu-header h1 { 
                font-size: 1.3em; 
            }
            #public-view .menu-item { 
                flex-direction: row; 
                align-items: flex-start; 
                gap: 10px; 
            }
            #public-view .menu-item-content { 
                flex: 1; 
                min-width: 0; 
            }
            #public-view .menu-item-price { 
                font-size: 1em; 
                margin-left: 8px; 
                flex-shrink: 0; 
            }
            #admin-view .admin-controls, 
            #admin-view .search-filters { 
                flex-direction: column; 
                gap: 8px; 
            }
            #admin-view .category-header { 
                flex-direction: column; 
                gap: 10px; 
            }
            #admin-view .category-header .category-actions { 
                display: flex; 
                gap: 5px; 
                flex-wrap: wrap; 
            }
            #admin-view .menu-item { 
                grid-template-columns: 1fr; 
                gap: 10px; 
            }
            #admin-view .menu-item-actions { 
                justify-content: flex-start; 
                flex-wrap: wrap; 
            }
            #admin-view .menu-item-actions input { 
                max-width: 100px; 
            }
            .stats-dashboard { 
                grid-template-columns: 1fr; 
                gap: 10px; 
            }
            .print-button { 
                width: 50px; 
                height: 50px; 
                font-size: 20px; 
                bottom: 15px; 
                right: 15px; 
            }
            .admin-top-bar { 
                flex-direction: column; 
                gap: 10px; 
                align-items: stretch; 
            }
            .admin-top-bar > div { 
                justify-content: center; 
            }
            .footer-info {
                padding: 15px;
                font-size: 0.8em;
            }
        }
        
        /* Tablets pequeñas (481px - 767px) */
        @media (min-width: 481px) and (max-width: 767px) {
            body { 
                padding: 10px; 
                padding-bottom: 100px; 
            }
            .main-container { 
                padding: 15px; 
            }
            .menu-header .header-title-group { 
                gap: 10px; 
            }
            .header-logo { 
                height: 85px; 
            }
            .menu-header h1 { 
                font-size: 1.5em; 
            }
            #public-view .menu-item { 
                flex-direction: column; 
                align-items: flex-start; 
                gap: 5px; 
            }
            #admin-view .admin-controls, 
            #admin-view .search-filters { 
                flex-direction: column; 
                gap: 10px; 
            }
            #admin-view .category-header { 
                flex-direction: column; 
                gap: 10px; 
            }
            #admin-view .category-header .category-actions { 
                display: flex; 
                gap: 10px; 
            }
            #admin-view .menu-item { 
                grid-template-columns: 1fr; 
            }
            #admin-view .menu-item-actions { 
                justify-content: flex-start; 
            }
            #admin-view .menu-item-actions input { 
                max-width: 120px; 
            }
            .stats-dashboard { 
                grid-template-columns: repeat(2, 1fr); 
                gap: 15px; 
            }
        }
        
        /* Tablets grandes (768px - 1023px) */
        @media (min-width: 768px) and (max-width: 1023px) {
            .main-container { 
                max-width: 800px; 
                padding: 25px; 
            }
            .stats-dashboard { 
                grid-template-columns: repeat(3, 1fr); 
                gap: 20px; 
            }
            #admin-view .menu-item { 
                grid-template-columns: auto 1fr auto; 
            }
            .header-logo { 
                height: 100px; 
            }
            .menu-header h1 { 
                font-size: 2em; 
            }
        }
        
        /* Pantallas medianas (1024px - 1439px) */
        @media (min-width: 1024px) and (max-width: 1439px) {
            .main-container { 
                max-width: 1000px; 
                padding: 30px; 
            }
            .stats-dashboard { 
                grid-template-columns: repeat(4, 1fr); 
                gap: 20px; 
            }
            #admin-view .menu-item { 
                grid-template-columns: auto 1fr auto; 
            }
            .header-logo { 
                height: 120px; 
            }
            .menu-header h1 { 
                font-size: 2.5em; 
            }
        }
        
        /* Pantallas grandes (1440px - 1919px) */
        @media (min-width: 1440px) and (max-width: 1919px) {
            .main-container { 
                max-width: 1200px; 
                padding: 35px; 
            }
            .stats-dashboard { 
                grid-template-columns: repeat(5, 1fr); 
                gap: 25px; 
            }
            .menu-header h1 { 
                font-size: 3em; 
            }
            .header-logo { 
                height: 140px; 
            }
        }
        
        /* Pantallas ultra-wide (≥1920px) */
        @media (min-width: 1920px) {
            .main-container { 
                max-width: 1400px; 
                padding: 40px; 
            }
            .stats-dashboard { 
                grid-template-columns: repeat(6, 1fr); 
                gap: 30px; 
            }
            .menu-header h1 { 
                font-size: 3.5em; 
            }
            .header-logo { 
                height: 160px; 
            }
            #public-view .menu-category h2 {
                font-size: 2.2em;
            }
            #public-view .menu-item-name {
                font-size: 1.2em;
            }
            #public-view .menu-item-price {
                font-size: 1.3em;
            }
        }
        
        /* Orientación landscape en móviles */
        @media (max-width: 768px) and (orientation: landscape) {
            body {
                padding: 5px;
            }
            .main-container {
                padding: 10px;
            }
            .menu-header .header-title-group {
                flex-direction: row;
                gap: 15px;
            }
            .header-logo {
                height: 30px;
            }
            .menu-header h1 {
                font-size: 1.2em;
            }
        }
        
        /* Estilos adicionales para modo oscuro */
        body.dark-mode * {
            color: inherit;
        }
        
        body.dark-mode .menu-header h1,
        body.dark-mode .menu-header h2,
        body.dark-mode .menu-header h3,
        body.dark-mode .menu-header h4,
        body.dark-mode .menu-header h5,
        body.dark-mode .menu-header h6 {
            color: #ffffff !important;
        }
        
        body.dark-mode #public-view .menu-item-name,
        body.dark-mode #public-view .menu-item-description,
        body.dark-mode #public-view .menu-item-price {
            color: #ffffff !important;
        }
        
        body.dark-mode #public-view .menu-item-description {
            color: #cccccc !important;
        }
        
        body.dark-mode #public-view .menu-item-price {
            color: var(--primary-green) !important;
        }
        
        body.dark-mode .admin-controls input,
        body.dark-mode .admin-controls textarea,
        body.dark-mode .admin-controls select {
            background: #3a3a3a !important;
            color: #ffffff !important;
            border-color: #4a4a4a !important;
        }
        
        body.dark-mode .category-header input {
            background: #3a3a3a !important;
            color: #ffffff !important;
            border-color: #4a4a4a !important;
        }
        
        body.dark-mode .menu-item-admin input,
        body.dark-mode .menu-item-admin textarea {
            background: #3a3a3a !important;
            color: #ffffff !important;
            border-color: #4a4a4a !important;
        }
        
        body.dark-mode .btn i,
        body.dark-mode .btn-icon i,
        body.dark-mode .header-btn i {
            color: #ffffff !important;
        }
        
        body.dark-mode .btn-icon {
            color: #ffffff !important;
        }
        
        body.dark-mode .header-btn {
            color: #ffffff !important;
        }
        
        /* Estilos para el modal de login en modo oscuro */
        body.dark-mode #admin-login-modal .bg-white {
            background: #2d2d2d !important;
            color: #ffffff !important;
        }
        
        body.dark-mode #admin-login-modal h3 {
            color: #ffffff !important;
        }
        
        body.dark-mode #admin-login-modal input {
            background: #3a3a3a !important;
            color: #ffffff !important;
            border-color: #4a4a4a !important;
        }
        
        body.dark-mode #admin-login-modal input::placeholder {
            color: #cccccc !important;
        }
        
        body.dark-mode #admin-login-modal #toggle-password {
            color: #cccccc !important;
        }
        
        body.dark-mode #admin-login-modal #toggle-password:hover {
            color: #ffffff !important;
        }
        
        body.dark-mode #admin-login-modal #close-admin-modal-button {
            background: #4a4a4a !important;
            color: #ffffff !important;
        }
        
        body.dark-mode #admin-login-modal #close-admin-modal-button:hover {
            background: #5a5a5a !important;
        }
        
        body.dark-mode .header-btn {
            color: #ffffff !important;
        }
        
        /* Arreglar botones específicos en modo oscuro */
        body.dark-mode #admin-button,
        body.dark-mode #back-button,
        body.dark-mode .admin-button,
        body.dark-mode .back-button {
            background: #3a3a3a !important;
            color: #ffffff !important;
            border-color: #4a4a4a !important;
        }
        
        body.dark-mode #admin-button:hover,
        body.dark-mode #back-button:hover,
        body.dark-mode .admin-button:hover,
        body.dark-mode .back-button:hover {
            background: #404040 !important;
        }
        
        /* Arreglar fondo del header en modo oscuro */
        body.dark-mode .admin-header,
        body.dark-mode .header-bar {
            background: #2d2d2d !important;
            color: #ffffff !important;
        }
        
        /* Arreglar cualquier elemento con fondo negro */
        body.dark-mode .bg-black,
        body.dark-mode [class*="bg-black"] {
            background: #2d2d2d !important;
        }
        
        body.dark-mode .text-black,
        body.dark-mode [class*="text-black"] {
            color: #ffffff !important;
        }
        
        /* Estilos más específicos para botones en modo oscuro */
        body.dark-mode button#show-admin-button,
        body.dark-mode button#back-button,
        body.dark-mode button#toggle-theme-button {
            background: #3a3a3a !important;
            color: #ffffff !important;
            border: 1px solid #4a4a4a !important;
        }
        
        body.dark-mode button#show-admin-button:hover,
        body.dark-mode button#back-button:hover,
        body.dark-mode button#toggle-theme-button:hover {
            background: #404040 !important;
        }
        
        body.dark-mode button#show-admin-button i,
        body.dark-mode button#back-button i,
        body.dark-mode button#toggle-theme-button i {
            color: #ffffff !important;
        }
        
        /* Sobrescribir clases bg-white en modo oscuro */
        body.dark-mode .bg-white {
            background: #2d2d2d !important;
        }
        
        body.dark-mode button.bg-white {
            background: #3a3a3a !important;
        }
        
        body.dark-mode .text-gray-600 {
            color: #ffffff !important;
        }
        
        body.dark-mode button.text-gray-600 {
            color: #ffffff !important;
        }
        
        /* Asegurar que no haya bordes negros en modo oscuro */
        body.dark-mode * {
            border-color: #4a4a4a !important;
        }
        
        body.dark-mode .menu-header {
            border-bottom-color: #4a4a4a !important;
        }
        
        body.dark-mode .menu-category h2 {
            border-bottom-color: var(--primary-green) !important;
        }
        
        /* Estilos para descuentos en modo oscuro */
        body.dark-mode .menu-item-price span[style*="text-decoration: line-through"] {
            color: #666 !important;
        }
        
        body.dark-mode .menu-item-price span[style*="color: #e53e3e"] {
            color: #f56565 !important;
        }
        
        body.dark-mode .menu-item-price span[style*="background: #e53e3e"] {
            background: #f56565 !important;
            color: #ffffff !important;
        }
        
        /* Estilos para precios con descuento - VERSIÓN OPTIMIZADA */
        .price-with-discount {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 3px;
            margin-top: 5px;
        }
        
        .original-price {
            text-decoration: line-through;
            color: #999;
            font-size: 0.9em;
            font-weight: normal;
            opacity: 0.7;
        }
        
        .discount-badge {
            background: linear-gradient(135deg, #e53e3e, #c53030);
            color: white;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            letter-spacing: 0.5px;
        }
        
        .final-price {
            font-size: 1.3em;
            font-weight: bold;
            color: var(--primary-blue);
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .final-price.discounted {
            color: #e53e3e;
            font-size: 1.4em;
            text-shadow: 0 2px 4px rgba(229, 62, 62, 0.3);
        }
        
        /* Estilos para precios con descuento en modo oscuro */
        body.dark-mode .original-price {
            color: #888 !important;
            opacity: 0.8;
        }
        
        body.dark-mode .discount-badge {
            background: linear-gradient(135deg, #f56565, #e53e3e) !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.4) !important;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        
        body.dark-mode .final-price {
            color: #60a5fa !important;
            text-shadow: 0 1px 3px rgba(96, 165, 250, 0.4);
        }
        
        body.dark-mode .final-price.discounted {
            color: #f56565 !important;
            text-shadow: 0 2px 4px rgba(245, 101, 101, 0.4);
        }
        
        /* Responsive para descuentos en móviles */
        @media (max-width: 480px) {
            .price-with-discount {
                gap: 2px;
                margin-top: 3px;
            }
            
            .original-price {
                font-size: 0.8em;
            }
            
            .discount-badge {
                padding: 2px 8px;
                font-size: 0.75em;
            }
            
            .final-price {
                font-size: 1.2em;
            }
            
            .final-price.discounted {
                font-size: 1.3em;
            }
        }
        
        /* Estilos específicos para el modal de login en modo oscuro */
        body.dark-mode #admin-login-modal .bg-white {
            background: #2d2d2d !important;
            border-color: #4a4a4a !important;
        }
        
        body.dark-mode #admin-login-modal .bg-gray-100 {
            background: #3a3a3a !important;
        }
        
        body.dark-mode #admin-login-modal .text-gray-600 {
            color: #cccccc !important;
        }
        
        body.dark-mode #admin-login-modal .text-gray-900 {
            color: #ffffff !important;
        }
        
        body.dark-mode #admin-login-modal .text-gray-700 {
            color: #cccccc !important;
        }
        
        body.dark-mode #admin-login-modal .text-gray-500 {
            color: #cccccc !important;
        }
        
        body.dark-mode #admin-login-modal .text-gray-800 {
            color: #ffffff !important;
        }
        
        body.dark-mode #admin-login-modal .bg-gray-200 {
            background: #3a3a3a !important;
            color: #ffffff !important;
        }
        
        body.dark-mode #admin-login-modal .bg-gray-200:hover {
            background: #4a4a4a !important;
        }
        
        body.dark-mode #admin-login-modal .hover\:bg-gray-300:hover {
            background: #4a4a4a !important;
        }
        
        body.dark-mode #admin-login-modal .hover\:text-gray-700:hover {
            color: #ffffff !important;
        }
        
        body.dark-mode #admin-login-modal input {
            background: #3a3a3a !important;
            color: #ffffff !important;
            border-color: #4a4a4a !important;
        }
        
        body.dark-mode #admin-login-modal input::placeholder {
            color: #888888 !important;
        }
        
        body.dark-mode #admin-login-modal .focus\:ring-green-500:focus {
            box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.5) !important;
        }
        
        body.dark-mode #admin-login-modal .border-gray-300 {
            border-color: #4a4a4a !important;
        }
        
        /* Estilos para el modal de agregar productos en modo oscuro */
        body.dark-mode #add-product-modal .bg-white {
            background: #2d2d2d !important;
            border-color: #4a4a4a !important;
        }
        
        body.dark-mode #add-product-modal .text-gray-900 {
            color: #ffffff !important;
        }
        
        body.dark-mode #add-product-modal .text-gray-700 {
            color: #cccccc !important;
        }
        
        body.dark-mode #add-product-modal .text-gray-400 {
            color: #888888 !important;
        }
        
        body.dark-mode #add-product-modal .hover\:text-gray-600:hover {
            color: #cccccc !important;
        }
        
        body.dark-mode #add-product-modal input,
        body.dark-mode #add-product-modal textarea,
        body.dark-mode #add-product-modal select {
            background: #3a3a3a !important;
            color: #ffffff !important;
            border-color: #4a4a4a !important;
        }
        
        body.dark-mode #add-product-modal input::placeholder,
        body.dark-mode #add-product-modal textarea::placeholder {
            color: #888888 !important;
        }
        
        body.dark-mode #add-product-modal .focus\:ring-blue-500:focus {
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5) !important;
        }
        
        body.dark-mode #add-product-modal .focus\:border-blue-500:focus {
            border-color: #3b82f6 !important;
        }
        
        body.dark-mode #add-product-modal .border-gray-300 {
            border-color: #4a4a4a !important;
        }
        
        body.dark-mode #add-product-modal .text-blue-500 {
            color: #60a5fa !important;
        }
        
        body.dark-mode #add-product-modal .text-blue-600 {
            color: #60a5fa !important;
        }
        
        body.dark-mode #add-product-modal .focus\:ring-blue-500:focus {
            box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.5) !important;
        }
        
        /* Estilos para formatear precio con descuento */
        .price-with-discount {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 3px;
            margin-top: 5px;
        }
        
        .original-price {
            text-decoration: line-through;
            color: #999;
            font-size: 0.9em;
            font-weight: normal;
            opacity: 0.7;
        }
        
        .discount-badge {
            background: linear-gradient(135deg, #e53e3e, #c53030);
            color: white;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            letter-spacing: 0.5px;
        }
        
        .final-price {
            font-size: 1.3em;
            font-weight: bold;
            color: var(--primary-blue);
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .final-price.discounted {
            color: #e53e3e;
            font-size: 1.4em;
            text-shadow: 0 2px 4px rgba(229, 62, 62, 0.3);
        }
        
        /* Estilos para precios con descuento en modo oscuro */
        body.dark-mode .original-price {
            color: #888 !important;
            opacity: 0.8;
        }
        
        body.dark-mode .discount-badge {
            background: linear-gradient(135deg, #f56565, #e53e3e) !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.4) !important;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        
        body.dark-mode .final-price {
            color: #60a5fa !important;
            text-shadow: 0 1px 3px rgba(96, 165, 250, 0.4);
        }
        
        body.dark-mode .final-price.discounted {
            color: #f56565 !important;
            text-shadow: 0 2px 4px rgba(245, 101, 101, 0.4);
        }
        
        /* Responsive para descuentos en móviles */
        @media (max-width: 480px) {
            .price-with-discount {
                gap: 2px;
                margin-top: 3px;
            }
            
            .original-price {
                font-size: 0.8em;
            }
            
            .discount-badge {
                padding: 2px 8px;
                font-size: 0.75em;
            }
            
            .final-price {
                font-size: 1.2em;
            }
            
            .final-price.discounted {
                font-size: 1.3em;
            }
        }
        
        /* Estilos específicos para el modal de login en modo oscuro */
        body.dark-mode #admin-login-modal .bg-white {
            background: #2d2d2d !important;
            border-color: #4a4a4a !important;
        }
        
        body.dark-mode #admin-login-modal .bg-gray-100 {
            background: #3a3a3a !important;
        }
        
        body.dark-mode #admin-login-modal .text-gray-600 {
            color: #cccccc !important;
        }
        
        body.dark-mode #admin-login-modal .text-gray-900 {
            color: #ffffff !important;
        }
        
        body.dark-mode #admin-login-modal .text-gray-700 {
            color: #cccccc !important;
        }
        
        body.dark-mode #admin-login-modal .text-gray-500 {
            color: #cccccc !important;
        }
        
        body.dark-mode #admin-login-modal .text-gray-800 {
            color: #ffffff !important;
        }
        
        body.dark-mode #admin-login-modal .bg-gray-200 {
            background: #3a3a3a !important;
            color: #ffffff !important;
        }
        
        body.dark-mode #admin-login-modal .bg-gray-200:hover {
            background: #4a4a4a !important;
        }
        
        body.dark-mode #admin-login-modal .hover\:bg-gray-300:hover {
            background: #4a4a4a !important;
        }
        
        body.dark-mode #admin-login-modal .hover\:text-gray-700:hover {
            color: #ffffff !important;
        }
        
        body.dark-mode #admin-login-modal input {
            background: #3a3a3a !important;
            color: #ffffff !important;
            border-color: #4a4a4a !important;
        }
        
        body.dark-mode #admin-login-modal input::placeholder {
            color: #888888 !important;
        }
        
        body.dark-mode #admin-login-modal .focus\:ring-green-500:focus {
            box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.5) !important;
        }
        
        body.dark-mode #admin-login-modal .border-gray-300 {
            border-color: #4a4a4a !important;
        }
        
        /* Estilos para el modal de agregar productos en modo oscuro */
        body.dark-mode #add-product-modal .bg-white {
            background: #2d2d2d !important;
            border-color: #4a4a4a !important;
        }
        
        body.dark-mode #add-product-modal .text-gray-900 {
            color: #ffffff !important;
        }
        
        body.dark-mode #add-product-modal .text-gray-700 {
            color: #cccccc !important;
        }
        
        body.dark-mode #add-product-modal .text-gray-400 {
            color: #888888 !important;
        }
        
        body.dark-mode #add-product-modal .hover\:text-gray-600:hover {
            color: #cccccc !important;
        }
        
        body.dark-mode #add-product-modal input,
        body.dark-mode #add-product-modal textarea,
        body.dark-mode #add-product-modal select {
            background: #3a3a3a !important;
            color: #ffffff !important;
            border-color: #4a4a4a !important;
        }
        
        body.dark-mode #add-product-modal input::placeholder,
        body.dark-mode #add-product-modal textarea::placeholder {
            color: #888888 !important;
        }
        
        body.dark-mode #add-product-modal .focus\:ring-blue-500:focus {
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5) !important;
        }
        
        body.dark-mode #add-product-modal .focus\:border-blue-500:focus {
            border-color: #3b82f6 !important;
        }
        
        body.dark-mode #add-product-modal .border-gray-300 {
            border-color: #4a4a4a !important;
        }
        
        body.dark-mode #add-product-modal .text-blue-500 {
            color: #60a5fa !important;
        }
        
        body.dark-mode #add-product-modal .text-blue-600 {
            color: #60a5fa !important;
        }
        
        body.dark-mode #add-product-modal .focus\:ring-blue-500:focus {
            box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.5) !important;
        }
        
        /* Estilos para el modal de resultados de encuestas */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            margin: 5% auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(0,0,0,0.1);
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5em;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .close:hover {
            color: #f0f0f0;
            transform: scale(1.1);
        }

        .modal-body {
            padding: 25px;
            color: #333;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
        }

        .survey-results {
            max-height: 400px;
            overflow-y: auto;
        }

        .survey-item {
            background: rgba(0,0,0,0.05);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 1px solid rgba(0,0,0,0.1);
        }

        .survey-title {
            color: #d97706;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .survey-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-item {
            background: rgba(0,0,0,0.05);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.2em;
            font-weight: 600;
            color: #d97706;
        }

        .stat-label {
            font-size: 0.8em;
            color: #666;
        }

        .responses-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .response-item {
            background: rgba(0,0,0,0.03);
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 6px;
            border-left: 3px solid #d97706;
        }

        .response-date {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 5px;
        }

        .response-data {
            font-size: 0.9em;
        }
        
        /* Estilos para el modal de encuestas en modo oscuro */
        body.dark-mode .modal-content {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            border-color: rgba(255,255,255,0.1);
        }
        
        body.dark-mode .modal-body {
            color: #F2F2F2;
        }
        
        body.dark-mode .survey-item {
            background: rgba(255,255,255,0.05);
            border-color: rgba(255,255,255,0.1);
        }
        
        body.dark-mode .survey-title {
            color: #f59e0b;
        }
        
        body.dark-mode .stat-item {
            background: rgba(255,255,255,0.05);
        }
        
        body.dark-mode .stat-value {
            color: #f59e0b;
        }
        
        body.dark-mode .stat-label {
            color: #A6A6A6;
        }
        
        body.dark-mode .response-item {
            background: rgba(255,255,255,0.03);
            border-left-color: #f59e0b;
        }
        
        body.dark-mode .response-date {
            color: #A6A6A6;
        }

        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                margin: 10% auto;
            }
            
            .modal-actions {
                flex-direction: column;
            }
            
            .survey-stats {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        /* Mejoras adicionales de responsive para móviles */
        @media (max-width: 480px) {
            .header-logo { 
                height: 100px !important; 
            }
            .menu-header h1 { 
                font-size: 1.4em !important; 
            }
            
            /* Mejorar botones del header */
            .menu-header .absolute {
                top: 10px !important;
            }
            
            .menu-header .absolute button {
                width: 40px !important;
                height: 40px !important;
                padding: 8px !important;
            }
            
            .menu-header .absolute button i {
                font-size: 18px !important;
            }
            
            #public-view .menu-item { 
                padding: 15px !important;
            }
            
            #public-view .menu-item-price { 
                font-size: 1.1em !important; 
            }
            

            
            .admin-top-bar button {
                padding: 10px 12px !important;
                font-size: 14px !important;
                min-height: 44px !important;
            }
            
            /* Mejorar modales en móviles */
            .modal-content {
                width: 95% !important;
                margin: 5% auto !important;
                max-height: 90vh !important;
            }
            
            .modal-header {
                padding: 15px !important;
            }
            
            .modal-header h2 {
                font-size: 1.3em !important;
            }
            
            .modal-body {
                padding: 15px !important;
            }
            
            .form-group input,
            .form-group textarea,
            .form-group select {
                padding: 12px !important;
                font-size: 16px !important;
            }
            
            .btn {
                padding: 12px 16px !important;
                font-size: 16px !important;
                min-height: 44px !important;
            }
        }
        
        /* Mejoras para tablets */
        @media (min-width: 481px) and (max-width: 768px) {
            .header-logo { 
                height: 90px !important; 
            }
            .menu-header h1 { 
                font-size: 1.6em !important; 
            }
            
            .menu-header .absolute button {
                width: 45px !important;
                height: 45px !important;
                padding: 10px !important;
            }
            
            .menu-header .absolute button i {
                font-size: 20px !important;
            }
            

            
            .admin-top-bar button {
                padding: 12px 16px !important;
                font-size: 15px !important;
                min-height: 48px !important;
            }
        }
        
        /* ===== MEJORAS RESPONSIVE PARA PANTALLAS PEQUEÑAS ===== */
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .main-container { 
                margin: 0; 
                border-radius: 0; 
                min-height: 100vh;
                padding: 15px 10px 20px;
            }
            
            .menu-header {
                padding-bottom: 20px;
                margin-bottom: 20px;
                flex-direction: column;
                gap: 15px;
            }
            
            .header-title-group {
                flex-direction: column;
                gap: 10px;
                text-align: center;
                padding-top: 2rem !important;
            }
            
            .header-logo {
                height: 50px;
            }
            
            .menu-header h1 {
                font-size: 1.8em;
                text-align: center;
            }
            
            /* Botones de navegación en móvil */
            .menu-header .absolute {
                position: relative !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                display: flex;
                gap: 8px;
                justify-content: center;
                margin-top: 10px;
                padding: 0 10px;
            }
            
            .menu-header .absolute button {
                padding: 8px 12px;
                font-size: 0.9em;
                border-radius: 6px;
                min-width: 80px;
                height: 36px;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 4px;
            }
            
            .menu-header .absolute button i {
                font-size: 1.2em;
            }
            
            /* Elementos del menú en móvil */
            #public-view .menu-category h2 {
                font-size: 1.4em;
                padding-bottom: 8px;
                margin-bottom: 15px;
            }
            
            #public-view .menu-item {
                padding: 15px;
                margin-bottom: 12px;
                border-radius: 12px;
                flex-direction: column;
                gap: 10px;
            }
            
            #public-view .menu-item-info {
                width: 100%;
            }
            
            #public-view .menu-item-name {
                font-size: 1.1em;
                margin-bottom: 6px;
            }
            
            #public-view .menu-item-description {
                font-size: 0.9em;
                line-height: 1.4;
            }
            
            #public-view .menu-item-price {
                font-size: 1.2em;
                margin-top: 8px;
                text-align: center;
            }
            
            .premium-indicator {
                font-size: 0.9em;
                margin-top: 6px;
                text-align: center;
            }
            
            /* Botones en móvil */
            .print-button,
            .btn {
                padding: 10px 16px;
                font-size: 0.9em;
                border-radius: 8px;
                min-height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 6px;
            }
            
            .print-button {
                background: #28a745 !important;
                color: white !important;
                margin: 10px auto;
                display: block;
                width: fit-content;
            }
            
            /* Panel de administración en móvil */
            #admin-view {
                padding: 10px;
            }
            
            #admin-view .admin-section {
                margin-bottom: 20px;
                padding: 15px;
                border-radius: 8px;
            }
            
            #admin-view .admin-section h3 {
                font-size: 1.2em;
                margin-bottom: 12px;
            }
            
            #admin-view .form-group {
                margin-bottom: 12px;
            }
            
            #admin-view .form-group label {
                font-size: 0.9em;
                margin-bottom: 4px;
                display: block;
            }
            
            #admin-view .form-group input,
            #admin-view .form-group textarea,
            #admin-view .form-group select {
                padding: 8px 10px;
                font-size: 16px;
                border-radius: 6px;
                width: 100%;
            }
            
            #admin-view .btn {
                padding: 10px 16px;
                font-size: 0.9em;
                margin: 4px 2px;
                min-width: 80px;
            }
            
            /* Estadísticas en móvil */
            .stats-dashboard {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .stat-card {
                padding: 15px;
                border-radius: 8px;
            }
            
            .stat-number {
                font-size: 1.8em;
            }
            
            .stat-label {
                font-size: 0.85em;
            }
            
            /* Modales en móvil */
            #admin-login-modal .relative,
            #add-product-modal .relative {
                margin: 10px;
                max-width: calc(100% - 20px);
                max-height: calc(100vh - 20px);
            }
            
            #admin-login-modal .relative,
            #add-product-modal .relative {
                padding: 15px;
            }
            
            /* Modo oscuro específico para móvil */
            body.dark-mode .main-container { 
                margin: 0; 
                border-radius: 0; 
                min-height: 100vh; 
            }
            
            body.dark-mode .print-button { 
                background: #28a745 !important; 
                color: white !important; 
            }
            
            body.dark-mode #back-button,
            body.dark-mode #show-admin-button,
            body.dark-mode #toggle-theme-button { 
                background: #2d2d2d !important; 
                color: #ffffff !important; 
            }
            
            body.dark-mode #back-button:hover,
            body.dark-mode #show-admin-button:hover,
            body.dark-mode #toggle-theme-button:hover { 
                background: #404040 !important; 
            }
            
            /* Asegurar que los precios se vean bien en modo oscuro en móvil */
            body.dark-mode #public-view .menu-item-price {
                color: #28a745 !important;
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3) !important;
            }
        }
        
        /* Mejoras para tablets */
        @media (min-width: 481px) and (max-width: 768px) {
            .main-container {
                padding: 20px 15px 30px;
            }
            
            .header-logo {
                height: 55px;
            }
            
            .menu-header h1 {
                font-size: 2.2em;
            }
            
            #public-view .menu-item {
                padding: 18px;
            }
            
            .stats-dashboard {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
        }
        
        /* Estilos para los botones del panel de administrador */
        .admin-buttons-container {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .admin-button {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        
        .admin-button i {
            font-size: 1rem;
        }
        
        .admin-button .button-text {
            display: inline;
        }
        
        .theme-button {
            background-color: #e5e7eb;
            color: #374151;
        }
        
        .theme-button:hover {
            background-color: #d1d5db;
        }
        
        .export-button {
            background-color: #dbeafe;
            color: #1e40af;
        }
        
        .export-button:hover {
            background-color: #bfdbfe;
        }
        
        .pdf-button {
            background-color: #dcfce7;
            color: #166534;
        }
        
        .pdf-button:hover {
            background-color: #bbf7d0;
        }
        
        .survey-button {
            background-color: #fed7aa;
            color: #c2410c;
        }
        
        .survey-button:hover {
            background-color: #fdba74;
        }
        
        .stats-button {
            background-color: #e0e7ff;
            color: #3730a3;
        }
        
        .stats-button:hover {
            background-color: #c7d2fe;
        }
        
        .visit-stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: 2px solid #5a67d8;
        }
        
        .visit-stat-card .stat-number {
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .visit-stat-card .stat-label {
            color: rgba(255,255,255,0.9);
        }
        
        .logout-button {
            background-color: #fee2e2;
            color: #dc2626;
        }
        
        .logout-button:hover {
            background-color: #fecaca;
        }
        
        /* Estilos responsivos para móviles pequeños (≤480px) */
        @media (max-width: 480px) {
            .admin-top-bar {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }
            
            .admin-buttons-container {
                flex-direction: column;
                gap: 8px;
                width: 100%;
            }
            
            .admin-button {
                width: 100%;
                justify-content: center;
                padding: 12px 16px;
                font-size: 1rem;
            }
            
            .admin-button i {
                font-size: 1.2rem;
            }
            
            .admin-button .button-text {
                display: inline;
            }
        }
        
        /* Estilos responsivos para tablets pequeñas (481px - 767px) */
        @media (min-width: 481px) and (max-width: 767px) {
            .admin-buttons-container {
                flex-wrap: wrap;
                gap: 8px;
                justify-content: center;
            }
            
            .admin-button {
                flex: 1;
                min-width: 140px;
                justify-content: center;
                padding: 10px 12px;
            }
            
            .admin-button .button-text {
                display: inline;
            }
        }
        
        /* Estilos responsivos para tablets grandes (768px - 1023px) */
        @media (min-width: 768px) and (max-width: 1023px) {
            .admin-buttons-container {
                gap: 8px;
            }
            
            .admin-button {
                padding: 8px 10px;
                font-size: 0.8rem;
            }
            
            .admin-button i {
                font-size: 0.9rem;
            }
        }
        
        /* Modo oscuro para botones de administrador */
        body.dark-mode .theme-button {
            background-color: #4b5563;
            color: #f9fafb;
        }
        
        body.dark-mode .theme-button:hover {
            background-color: #6b7280;
        }
        
        body.dark-mode .export-button {
            background-color: #1e3a8a;
            color: #dbeafe;
        }
        
        body.dark-mode .export-button:hover {
            background-color: #1e40af;
        }
        
        body.dark-mode .pdf-button {
            background-color: #166534;
            color: #dcfce7;
        }
        
        body.dark-mode .pdf-button:hover {
            background-color: #15803d;
        }
        
        body.dark-mode .survey-button {
            background-color: #c2410c;
            color: #fed7aa;
        }
        
        body.dark-mode .survey-button:hover {
            background-color: #ea580c;
        }
        
        body.dark-mode .stats-button {
            background-color: #3730a3;
            color: #e0e7ff;
        }
        
        body.dark-mode .stats-button:hover {
            background-color: #4338ca;
        }
        
        body.dark-mode .logout-button {
            background-color: #dc2626;
            color: #fee2e2;
        }
        
        body.dark-mode .logout-button:hover {
            background-color: #ef4444;
        }
        
        /* Estilos para el modal de estadísticas */
        .statistics-container {
            max-height: 70vh;
            overflow-y: auto;
        }
        
        /* Estilos para estadísticas por sitio */
        .site-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .site-stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 20px;
            color: white;
            border: 2px solid #5a67d8;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .site-header {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .site-header h4 {
            margin: 0 0 5px 0;
            font-size: 1.2rem;
            font-weight: 600;
            color: white;
        }
        
        .site-url {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.8);
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 12px;
        }
        
        .site-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
        }
        
        .metric-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .metric-item strong {
            color: #fbbf24;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .stats-details {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        .stats-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e9ecef;
        }
        
        .stats-section h3 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .period-stats,
        .device-stats,
        .referrer-stats,
        .hourly-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        
        .period-item,
        .device-item,
        .referrer-item,
        .hour-item {
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            font-size: 0.9rem;
        }
        
        .recent-visits-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .recent-site-visits h4 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 1.1rem;
            font-weight: 600;
            padding-bottom: 8px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .recent-visits {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .visit-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            margin-bottom: 10px;
        }
        
        .visit-date {
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
        }
        
        .visit-details {
            font-size: 0.85rem;
            color: #6c757d;
            line-height: 1.4;
        }
        
        .stats-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #dee2e6;
        }
        
        /* Modo oscuro para estadísticas */
        body.dark-mode .stats-section {
            background: #2d3748;
            border-color: #4a5568;
        }
        
        body.dark-mode .stats-section h3 {
            color: #e2e8f0;
        }
        
        body.dark-mode .period-item,
        body.dark-mode .device-item,
        body.dark-mode .referrer-item,
        body.dark-mode .hour-item,
        body.dark-mode .visit-item {
            background: #4a5568;
            border-color: #718096;
            color: #e2e8f0;
        }
        
        body.dark-mode .visit-date {
            color: #f7fafc;
        }
        
        body.dark-mode .visit-details {
            color: #cbd5e0;
        }
        
        /* Responsive para estadísticas */
        @media (max-width: 768px) {
            .stats-overview {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .site-stats {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .site-metrics {
                grid-template-columns: 1fr;
            }
            
            .recent-visits-container {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .period-stats,
            .device-stats,
            .referrer-stats,
            .hourly-stats {
                grid-template-columns: 1fr;
            }
            
            .stats-actions {
                flex-direction: column;
            }
        }

        /* Estilos para el sistema de fidelización en carta.html */
        .loyalty-section {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
            color: white;
            text-align: center;
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
        }

        .loyalty-section h3 {
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 15px;
            color: white;
        }

        .loyalty-points {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .loyalty-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .loyalty-button {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .loyalty-button:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
            transform: translateY(-2px);
        }

        .loyalty-login {
            background: rgba(255,255,255,0.9);
            color: #28a745;
            border: 2px solid rgba(255,255,255,0.9);
        }

        .loyalty-login:hover {
            background: white;
            color: #15803d;
        }

        .loyalty-hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .loyalty-actions {
                flex-direction: column;
                align-items: center;
            }
            
            .loyalty-button {
                width: 100%;
                max-width: 250px;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <header class="menu-header">
             <div class="absolute top-0 left-4 right-4 flex justify-between z-20 pt-4">
                 <button id="back-button" onclick="if (window.history.length > 1) { window.history.back(); } else { window.location.href='index.html'; }" title="Volver atrás" class="p-2 bg-white text-gray-600 rounded-full shadow-md hover:bg-gray-100 transition">
                     <i class="ph ph-arrow-left text-2xl"></i>
                 </button>
                 <div class="flex gap-2">
                     <button id="toggle-theme-button" title="Cambiar tema" class="p-2 bg-white text-gray-600 rounded-full shadow-md hover:bg-gray-100 transition">
                         <i class="ph ph-sun text-2xl"></i>
                     </button>
                     <button id="show-admin-button" title="Acceso Administrador" class="p-2 bg-white text-gray-600 rounded-full shadow-md hover:bg-gray-100 transition">
                         <i class="ph ph-user-gear text-2xl"></i>
                     </button>
                 </div>
             </div>
             <div class="header-title-group" style="padding-top: 4rem;">
                 <img src="./Logo/Logo Los Nogales.png" alt="Logo Los Nogales" class="header-logo">
                 <h1>Parrilla Los Nogales</h1>
             </div>
        </header>

        <!-- Sección de Fidelización -->
        <div id="loyalty-section" class="loyalty-section loyalty-hidden">
            <h3>🎁 Programa de Fidelización</h3>
            <div class="loyalty-points" id="loyalty-points">0</div>
            <p>puntos disponibles</p>
            <div class="loyalty-actions">
                <button class="loyalty-button" onclick="claimDailyVisit()" id="daily-visit-btn">
                    <i class="ph-check-circle"></i>
                    Reclamar Visita (+10 pts)
                </button>
                <a href="./loyalty-system.html" class="loyalty-button">
                    <i class="ph-gift"></i>
                    Ver Premios
                </a>
                <a href="./loyalty-system.html" class="loyalty-button">
                    <i class="ph-user"></i>
                    Mi Perfil
                </a>
            </div>
        </div>

        <!-- Sección de Login para Fidelización -->
        <div id="loyalty-login-section" class="loyalty-section">
            <h3>🎁 Programa de Fidelización</h3>
            <p>Accede a tu cuenta para ver tus puntos y premios disponibles</p>
            <div class="loyalty-actions">
                <a href="./loyalty-system.html" class="loyalty-button loyalty-login">
                    <i class="ph-sign-in"></i>
                    Iniciar Sesión
                </a>
                <a href="./loyalty-system.html" class="loyalty-button">
                    <i class="ph-user-plus"></i>
                    Registrarse
                </a>
            </div>
        </div>

        <div id="public-view"></div>
        <div id="admin-view"></div>
    </div>
    
    <div id="admin-login-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="relative mx-auto p-5 border w-full max-w-sm shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-gray-100"><i class="ph ph-lock-key text-2xl text-gray-600"></i></div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">Acceso de Administrador</h3>
                <form id="admin-login-form" class="mt-4 px-7 py-3 space-y-3">
                    <div class="relative">
                        <input type="password" id="admin-password" placeholder="Contraseña" class="w-full p-2 pr-10 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500">
                        <button type="button" id="toggle-password" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                            <i class="ph ph-eye" id="password-icon"></i>
                        </button>
                    </div>
                    <button type="submit" class="w-full bg-green-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-800">Entrar</button>
                </form>
                <p id="admin-login-error" class="text-red-500 text-sm text-center h-4 mt-1"></p>
                <div class="items-center px-4 py-3">
                    <button id="close-admin-modal-button" class="mt-2 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para agregar productos -->
    <div id="add-product-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="relative mx-auto p-6 border w-full max-w-md shadow-xl rounded-lg bg-white">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-semibold text-gray-900">
                    <i class="ph ph-plus-circle text-blue-500"></i> Agregar Nuevo Producto
                </h3>
                <button id="close-product-modal-button" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">
                    <i class="ph ph-x"></i>
                </button>
            </div>
            
            <form id="add-product-form" class="space-y-4">
                <div>
                    <label for="modal-product-name" class="block text-sm font-medium text-gray-700 mb-1">Nombre del Producto *</label>
                    <input type="text" id="modal-product-name" required placeholder="Ej: Bife de Chorizo" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div>
                    <label for="modal-product-description" class="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
                    <textarea id="modal-product-description" rows="3" placeholder="Descripción del producto (opcional)" 
                              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none"></textarea>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="modal-product-price" class="block text-sm font-medium text-gray-700 mb-1">Precio *</label>
                        <input type="number" id="modal-product-price" required min="0" placeholder="0" 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-right">
                    </div>
                    <div>
                        <label for="modal-product-discount" class="block text-sm font-medium text-gray-700 mb-1">Descuento</label>
                        <div class="flex gap-2">
                            <input type="number" id="modal-product-discount" min="0" placeholder="0" 
                                   class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-right">
                            <select id="modal-product-discount-type" 
                                    class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="percentage">%</option>
                                <option value="pesos">$</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div>
                    <label for="modal-product-category" class="block text-sm font-medium text-gray-700 mb-1">Categoría *</label>
                    <select id="modal-product-category" required 
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Seleccionar categoría</option>
                    </select>
                </div>
                
                <div class="flex items-center space-x-3">
                    <label class="flex items-center">
                        <input type="checkbox" id="modal-product-premium" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="ml-2 text-sm text-gray-700">Marcar como Premium</span>
                    </label>
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button type="button" id="close-product-modal-button-2" 
                            class="flex-1 px-4 py-3 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300 transition">
                        Cancelar
                    </button>
                    <button type="submit" 
                            class="flex-1 px-4 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition">
                        <i class="ph ph-plus"></i> Agregar Producto
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para ver resultados de encuestas -->
    <div id="surveyResultsModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>📊 Resultados de Encuestas</h2>
                <span class="close" onclick="app.closeSurveyResultsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="surveyResultsContent"></div>
                <div class="modal-actions">
                    <button onclick="app.exportSurveyResults()" class="btn btn-secondary">Exportar Datos</button>
                    <button onclick="app.clearSurveyResults()" class="btn btn-danger">Limpiar Datos</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para ver estadísticas de visitas -->
    <div id="statisticsModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>📈 Estadísticas de Visitas</h2>
                <span class="close" onclick="app.closeStatisticsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="statisticsContent"></div>
            </div>
        </div>
    </div>

    <script>
    const firebaseConfig = {
        apiKey: "AIzaSyBS_eGNLqUH8SshfrnBaUvRTcjJKy5tFiI",
        authDomain: "losnogales-reservas.firebaseapp.com",
        projectId: "losnogales-reservas",
        storageBucket: "losnogales-reservas.appspot.com",
        messagingSenderId: "707614707617",
        appId: "1:707614707617:web:57ef12cf519d99ff8585e0",
        measurementId: "G-MBGF0QWF7K"
    };
    
    let app;

    try {
        // Verificar si Firebase ya está inicializado
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        app = {
            isAdmin: false,
            showHiddenInAdmin: false,
            hidePrices: false,
            darkMode: false,
            isPrinting: false, // Para evitar múltiples ventanas de impresión
            searchQuery: '',
            priceFilter: { min: 0, max: 999999 },
            statusFilter: 'all', // 'all', 'visible', 'hidden'
            sortBy: 'name', // 'name', 'price', 'created'
            sortOrder: 'asc',
            menuData: [],
            originalMenuData: [], // Para búsquedas
            nodes: {
                publicView: document.getElementById('public-view'),
                adminView: document.getElementById('admin-view'),
                adminButton: document.getElementById('show-admin-button'),
                backButton: document.getElementById('back-button'),
                toggleThemeButton: document.getElementById('toggle-theme-button'),
                loginModal: document.getElementById('admin-login-modal'),
                loginForm: document.getElementById('admin-login-form'),
                closeModalButton: document.getElementById('close-admin-modal-button'),
            },
            icons: {
                visible: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5C21.27 7.61 17 4.5 12 4.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>`,
                hidden: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.44-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/></svg>`,
                duplicate: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>`,
                image: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>`
            },
            
            // Funciones de utilidad
            showToast(message, type = 'info') {
                Toastify({
                    text: message,
                    duration: 1000,
                    gravity: "top",
                    position: "right",
                    className: `toast-${type}`,
                    stopOnFocus: true
                }).showToast();
            },
            
            showLoading(element) {
                if (element) {
                    element.innerHTML = '<span class="loading-spinner"></span> Guardando...';
                    element.disabled = true;
                }
            },
            
            hideLoading(element, originalText) {
                if (element) {
                    element.innerHTML = originalText;
                    element.disabled = false;
                }
            },
            
            validatePrice(price) {
                const numPrice = Number(price);
                return !isNaN(numPrice) && numPrice >= 0;
            },
            
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },
            
            // Función para ajustar automáticamente la altura del textarea
            autoResizeTextarea(textarea) {
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
            },
        
            async init() {
                this.nodes.adminButton.addEventListener('click', () => this.openLoginModal());
                this.nodes.toggleThemeButton.addEventListener('click', () => this.toggleDarkMode());
                this.nodes.loginForm.addEventListener('submit', (e) => this.handleLogin(e));
                this.nodes.closeModalButton.addEventListener('click', () => this.closeLoginModal());
                
                // Event listeners para el modal de productos
                document.getElementById('add-product-form').addEventListener('submit', (e) => this.handleAddProductForm(e));
                document.getElementById('close-product-modal-button').addEventListener('click', () => this.closeAddProductModal());
                document.getElementById('close-product-modal-button-2').addEventListener('click', () => this.closeAddProductModal());
                
                // Cerrar modal al hacer clic fuera
                document.getElementById('add-product-modal').addEventListener('click', (e) => {
                    if (e.target.id === 'add-product-modal') {
                        this.closeAddProductModal();
                    }
                });
                
                // Funcionalidad para mostrar/ocultar contraseña
                document.getElementById('toggle-password').addEventListener('click', () => {
                    const passwordInput = document.getElementById('admin-password');
                    const passwordIcon = document.getElementById('password-icon');
                    
                    if (passwordInput.type === 'password') {
                        passwordInput.type = 'text';
                        passwordIcon.className = 'ph ph-eye-slash';
                    } else {
                        passwordInput.type = 'password';
                        passwordIcon.className = 'ph ph-eye';
                    }
                });
                
                // Evento para cerrar modal de encuestas al hacer clic fuera
                document.getElementById('surveyResultsModal').addEventListener('click', (e) => {
                    if (e.target.id === 'surveyResultsModal') {
                        this.closeSurveyResultsModal();
                    }
                });
                
                // Evento para cerrar modal de estadísticas al hacer clic fuera
                document.getElementById('statisticsModal').addEventListener('click', (e) => {
                    if (e.target.id === 'statisticsModal') {
                        this.closeStatisticsModal();
                    }
                });
                
                // Inicializar búsqueda con debounce
                this.debouncedSearch = this.debounce((query) => this.searchItems(query), 300);
                
                // Atajos de teclado
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.key === 's' && this.isAdmin) {
                        e.preventDefault();
                        this.showToast('Guardando cambios...', 'info');
                    }
                    // Atajo para imprimir en vista pública
                    if (e.ctrlKey && e.key === 'p' && !this.isAdmin) {
                        e.preventDefault();
                        // Verificar si ya está imprimiendo antes de ejecutar
                        if (!this.isPrinting) {
                            this.printMenu();
                        } else {
                            console.log('Impresión ya en progreso, ignorando Ctrl+P');
                        }
                    }

                });
                
                // Migrar datos existentes y registrar nueva visita
                await this.migrateLocalVisitsToFirebase();
                this.recordVisit();
                
                // Agregar mensaje de bienvenida para nuevos visitantes
                if (!localStorage.getItem('menuVisited')) {
                    setTimeout(() => {
                        this.showToast('¡Bienvenido a Parrilla Los Nogales! Usa Ctrl+P para imprimir la carta', 'info');
                        localStorage.setItem('menuVisited', 'true');
                    }, 2000);
                }
                
                this.loadAndRenderData();
            },

            async loadAndRenderData(focusItemId = null) {
                this.showLoading();
                try {
                    const [categoriesSnapshot, itemsSnapshot] = await Promise.all([
                        db.collection('menuCategories').orderBy('order').get(),
                        db.collection('menu').orderBy('order').get()
                    ]);
                    const categories = categoriesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    const allItems = itemsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // Cargar configuración de precios desde localStorage (independiente por instancia)
                    const savedHidePrices = localStorage.getItem('hidePrices');
                    this.hidePrices = savedHidePrices === 'true';
                    
                    // Cargar modo oscuro desde localStorage (personalizado por dispositivo)
                    const savedDarkMode = localStorage.getItem('darkMode');
                    this.darkMode = savedDarkMode === 'true';
                    
                    this.menuData = categories.map(category => ({
                        ...category,
                        items: allItems.filter(item => item.categoryId === category.id).sort((a, b) => a.order - b.order)
                    }));
                    
                    // Guardar copia original para búsquedas
                    this.originalMenuData = JSON.parse(JSON.stringify(this.menuData));
                    
                    await this.render();

                    if (focusItemId) {
                        setTimeout(() => {
                            const newField = document.querySelector(`.menu-item[data-id="${focusItemId}"] input[type="text"]`);
                            if (newField) { newField.focus(); newField.select(); }
                        }, 100);
                    }
                } catch (error) {
                    console.error("Error al cargar datos desde Firestore:", error);
                    this.nodes.publicView.innerHTML = `<p class="text-red-500 text-center">Error al cargar el menú. Revisa la consola (F12).</p>`;
                }
            },
            
            async render() {
                this.nodes.publicView.style.display = this.isAdmin ? 'none' : 'block';
                this.nodes.adminView.style.display = this.isAdmin ? 'block' : 'none';
                
                this.nodes.adminButton.classList.toggle('hidden', this.isAdmin);
                this.nodes.backButton.classList.toggle('hidden', this.isAdmin);
                this.nodes.toggleThemeButton.classList.toggle('hidden', this.isAdmin);
                
                // Actualizar icono del botón de tema
                const themeIcon = this.nodes.toggleThemeButton.querySelector('i');
                if (themeIcon) {
                    themeIcon.className = `ph ${this.darkMode ? 'ph-moon' : 'ph-sun'} text-2xl`;
                }
                
                // Limpiar botón de imprimir existente
                const existingPrintButton = document.querySelector('.print-button');
                if (existingPrintButton) {
                    existingPrintButton.remove();
                }
                
                // Aplicar modo oscuro a todo el body si está activado
                document.body.classList.toggle('dark-mode', this.darkMode);
                
                if (this.isAdmin) {
                    await this.renderAdminView();
                } else {
                    this.renderPublicView();
                }
            },

            showLoading() { this.nodes.publicView.innerHTML = `<p class="text-center text-gray-500">Cargando...</p>`; },
            
            // Función para formatear precio con descuento
            formatPriceWithDiscount(price, discountValue, discountType = 'percentage') {
                if (!discountValue || discountValue <= 0) {
                    return `<span class="final-price">$${price.toLocaleString('es-AR')}</span>`;
                }
                
                const discountedPrice = this.calculateDiscountedPrice(price, discountValue, discountType);
                const discountText = discountType === 'percentage' ? `-${discountValue}%` : `-$${discountValue.toLocaleString('es-AR')}`;
                
                return `
                    <div class="price-with-discount">
                        <div class="original-price">$${price.toLocaleString('es-AR')}</div>
                        <div class="discount-badge">${discountText}</div>
                        <div class="final-price discounted">$${discountedPrice.toFixed(0)}</div>
                    </div>
                `;
            },
            
            // Función auxiliar para calcular precio con descuento
            calculateDiscountedPrice(price, discountValue, discountType = 'percentage') {
                if (!discountValue || discountValue <= 0) {
                    return price;
                }
                
                if (discountType === 'percentage') {
                    return price * (1 - discountValue / 100);
                } else {
                    // Descuento en pesos argentinos
                    return Math.max(0, price - discountValue);
                }
            },
            
            renderPublicView() {
                this.nodes.publicView.innerHTML = ''; 
                const visibleCategories = this.menuData.filter(category => !category.hidden);

                if (visibleCategories.length === 0) {
                    this.nodes.publicView.innerHTML = `
                        <div style="text-align: center; padding: 40px 20px;">
                            <i class="ph ph-coffee text-6xl text-gray-400 mb-4"></i>
                            <p class="text-gray-500 text-lg">No hay platos disponibles en este momento.</p>
                            <p class="text-gray-400 text-sm mt-2">¡Vuelve pronto para ver nuestro menú!</p>
                        </div>`;
                    return;
                }

                // No mostrar header info con contador de platos
                this.nodes.publicView.innerHTML = '';

                visibleCategories.forEach(category => {
                    const visibleItems = category.items.filter(item => !item.hidden);
                    if (visibleItems.length === 0) return;

                    const categoryElement = document.createElement('div');
                    categoryElement.className = 'menu-category mb-8';
                    
                    let itemsHtml = '';
                    visibleItems.forEach(item => {
                        const priceHtml = this.hidePrices ? '' : `<p class="menu-item-price">${this.formatPriceWithDiscount(item.price || 0, item.discountValue || 0, item.discountType || 'percentage')}</p>`;
                        
                        // Mostrar indicador premium solo si está marcado manualmente
                        const indicatorsHtml = item.premium ? 
                            `<div style="margin-top: 4px;"><span class="premium-indicator">⭐ PREMIUM</span></div>` : '';
                        
                        itemsHtml += `
                            <div class="menu-item">
                                <div class="menu-item-content">
                                    <p class="menu-item-name">${item.name || ''}</p>
                                    <p class="menu-item-description">${item.description || ''}</p>
                                    ${indicatorsHtml}
                                </div>
                                ${priceHtml}
                            </div>
                        `;
                    });

                    categoryElement.innerHTML = `
                        <h2>${category.name || 'Sin categoría'}</h2>
                        <div>${itemsHtml}</div>
                    `;
                    
                    this.nodes.publicView.appendChild(categoryElement);
                });
                
                // Agregar footer informativo
                const footerInfo = `
                    <div class="footer-info" style="text-align: center; margin-top: 40px; padding: 20px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 8px; border: 1px solid #dee2e6;">
                        <p style="margin: 0; color: #6c757d; font-size: 0.9em;">
                            <i class="ph ph-heart"></i> 
                            Parrilla Los Nogales - Sabor auténtico desde 1995
                        </p>
                        <p style="margin: 5px 0 0 0; color: #adb5bd; font-size: 0.8em;">
                            <i class="ph ph-phone"></i> Reservas: (011) 1234-5678 | 
                            <i class="ph ph-map-pin"></i> Av. Principal 123, CABA
                        </p>
                    </div>
                `;
                
                this.nodes.publicView.innerHTML += footerInfo;
                
                // Agregar botón de imprimir
                const printButton = document.createElement('button');
                printButton.className = 'print-button';
                printButton.innerHTML = '<i class="ph ph-printer" style="font-size: 1.2em;"></i>';
                printButton.title = 'Imprimir carta';
                printButton.onclick = () => this.printMenu();
                document.body.appendChild(printButton);
            },
            
            // Función para imprimir la carta
            printMenu() {
                // Evitar múltiples ventanas de impresión
                if (this.isPrinting) {
                    console.log('Impresión ya en progreso, ignorando clic');
                    return;
                }
                
                this.isPrinting = true;
                console.log('Iniciando impresión, isPrinting = true');
                
                try {
                    // Crear una ventana de impresión optimizada
                    const printWindow = window.open('', '_blank');
                    if (!printWindow) {
                        this.showToast('Error: No se pudo abrir la ventana de impresión. Verifica que no esté bloqueado el popup.', 'error');
                        this.isPrinting = false;
                        return;
                    }
                    
                    const menuContent = this.nodes.publicView.innerHTML;
                    
                    // Obtener la URL base para el logo
                    const logoUrl = window.location.origin + window.location.pathname.replace(/\/[^\/]*$/, '/') + 'Logo/Logo Los Nogales.png';
                    
                    printWindow.document.write(`
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <title>Menú - Parrilla Los Nogales</title>
                            <meta charset="UTF-8">
                            <style>
                                body { 
                                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
                                    margin: 0; 
                                    padding: 20px; 
                                    background: white; 
                                }
                                .menu-header { 
                                    text-align: center; 
                                    margin-bottom: 30px; 
                                    border-bottom: 2px solid #333; 
                                    padding-bottom: 20px; 
                                }
                                .header-logo { 
                                    height: 60px; 
                                    width: auto; 
                                    max-width: 200px;
                                }
                                .menu-header h1 { 
                                    color: #000; 
                                    font-size: 2.5em; 
                                    font-weight: 700; 
                                    margin: 10px 0; 
                                }
                                .menu-category h2 { 
                                    font-size: 1.8em; 
                                    color: #000; 
                                    border-bottom: 2px solid #28a745; 
                                    padding-bottom: 10px; 
                                    margin-bottom: 20px; 
                                }
                                .menu-item { 
                                    display: flex; 
                                    justify-content: space-between; 
                                    align-items: flex-start; 
                                    gap: 15px; 
                                    padding: 15px 0; 
                                    border-bottom: 1px dashed #ccc; 
                                }
                                .menu-item-name { font-weight: 600; margin: 0; }
                                .menu-item-description { 
                                    font-style: italic; 
                                    color: #666; 
                                    font-size: 0.9em; 
                                    margin: 4px 0 0 0; 
                                }
                                .menu-item-price { 
                                    font-weight: 700; 
                                    color: #28a745; 
                                    white-space: nowrap; 
                                    font-size: 1.1em; 
                                    margin: 0; 
                                }
                                .premium-indicator { 
                                    background: #ffd700; 
                                    color: #8b4513; 
                                    padding: 2px 8px; 
                                    border-radius: 12px; 
                                    font-size: 0.7em; 
                                    font-weight: bold; 
                                    display: inline-block; 
                                    margin-left: 8px; 
                                }
                                .footer-info {
                                    text-align: center;
                                    margin-top: 40px;
                                    padding: 20px;
                                    background: #f8f9fa;
                                    border-radius: 8px;
                                    border: 1px solid #dee2e6;
                                }
                                @media print {
                                    body { margin: 0; padding: 10px; }
                                    .menu-item { page-break-inside: avoid; }
                                    .footer-info { 
                                        background: #f8f9fa !important; 
                                        -webkit-print-color-adjust: exact;
                                        color-adjust: exact;
                                    }
                                }
                            </style>
                        </head>
                        <body>
                            <div class="menu-header">
                                <img src="${logoUrl}" alt="Logo Los Nogales" class="header-logo" onerror="this.style.display='none'">
                                <h1>Parrilla Los Nogales</h1>
                            </div>
                            ${menuContent}
                        </body>
                        </html>
                    `);
                    
                    printWindow.document.close();
                    
                    // Variable para controlar si ya se ejecutó la impresión
                    let printExecuted = false;
                    
                    // Listener para cuando se cierre la ventana manualmente
                    printWindow.addEventListener('beforeunload', () => {
                        console.log('Ventana de impresión cerrada manualmente');
                        this.isPrinting = false;
                    });
                    
                    // Listener para cuando se complete o cancele la impresión
                    printWindow.addEventListener('afterprint', () => {
                        console.log('Impresión completada o cancelada');
                        this.isPrinting = false;
                        if (printWindow && !printWindow.closed) {
                            printWindow.close();
                        }
                    });
                    

                    
                    // Función para ejecutar la impresión una sola vez
                    const executePrint = () => {
                        if (printExecuted) {
                            console.log('Impresión ya ejecutada, ignorando');
                            return;
                        }
                        printExecuted = true;
                        console.log('Ejecutando impresión');
                        printWindow.focus();
                        printWindow.print();
                    };
                    
                    // Esperar a que se cargue el contenido antes de imprimir
                    printWindow.onload = function() {
                        console.log('Ventana de impresión cargada');
                        executePrint();
                    };
                    
                    // Fallback si onload no funciona (solo una vez)
                    setTimeout(() => {
                        if (!printWindow.closed && !printExecuted) {
                            console.log('Ejecutando fallback de impresión');
                            executePrint();
                        }
                    }, 1500);
                    
                } catch (error) {
                    console.error('Error al imprimir:', error);
                    this.showToast('Error al generar la impresión. Intenta nuevamente.', 'error');
                    this.isPrinting = false;
                }
            },

            async renderAdminView() {
                // Calcular estadísticas del menú
                const totalCategories = this.menuData.length;
                const totalItems = this.menuData.reduce((sum, cat) => sum + cat.items.length, 0);
                const visibleItems = this.menuData.reduce((sum, cat) => sum + cat.items.filter(item => !item.hidden).length, 0);
                const hiddenItems = totalItems - visibleItems;
                const avgPrice = totalItems > 0 ? this.menuData.reduce((sum, cat) => sum + cat.items.reduce((catSum, item) => catSum + (item.price || 0), 0), 0) / totalItems : 0;
                
                // Obtener estadísticas rápidas de visitas
                const visitStats = await this.getQuickStats();
                
                this.nodes.adminView.innerHTML = `
                    <div class="admin-top-bar">
                        <h3>Modo Administrador</h3>
                        <div class="admin-buttons-container">
                            <button onclick="app.toggleDarkMode()" class="admin-button theme-button">
                                <i class="ph ${this.darkMode ? 'ph-sun' : 'ph-moon'}"></i> 
                                <span class="button-text">${this.darkMode ? 'Claro' : 'Oscuro'}</span>
                            </button>
                            <button onclick="app.exportMenu()" class="admin-button export-button">
                                <i class="ph ph-download"></i> 
                                <span class="button-text">Exportar JSON</span>
                            </button>
                            <button onclick="app.exportToPDF()" class="admin-button pdf-button">
                                <i class="ph ph-file-pdf"></i> 
                                <span class="button-text">Exportar PDF</span>
                            </button>
                            <button onclick="app.openSurveyResultsModal()" class="admin-button survey-button">
                                <i class="ph ph-chart-bar"></i> 
                                <span class="button-text">Ver Encuestas</span>
                            </button>
                            <button onclick="app.openStatisticsModal()" class="admin-button stats-button">
                                <i class="ph ph-chart-line"></i> 
                                <span class="button-text">Estadísticas</span>
                            </button>
                            <button onclick="app.logout()" class="admin-button logout-button">
                                <i class="ph ph-sign-out"></i> 
                                <span class="button-text">Salir</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="stats-dashboard">
                        <div class="stat-card">
                            <div class="stat-number">${totalCategories}</div>
                            <div class="stat-label">Categorías</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${totalItems}</div>
                            <div class="stat-label">Platos Totales</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${visibleItems}</div>
                            <div class="stat-label">Platos Visibles</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${hiddenItems}</div>
                            <div class="stat-label">Platos Ocultos</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">$${Math.round(avgPrice).toLocaleString('es-AR')}</div>
                            <div class="stat-label">Precio Promedio</div>
                        </div>
                        <div class="stat-card visit-stat-card">
                            <div class="stat-number">${visitStats.totalVisits.toLocaleString('es-AR')}</div>
                            <div class="stat-label">Total Visitas</div>
                        </div>
                        <div class="stat-card visit-stat-card">
                            <div class="stat-number">${visitStats.todayVisits}</div>
                            <div class="stat-label">Visitas Hoy</div>
                        </div>
                    </div>
                    
                    <div class="search-filters">
                        <input type="text" id="search-input" placeholder="Buscar platos o categorías..." style="flex-grow: 1;" oninput="app.debouncedSearch(this.value)">
                        <select id="status-filter" onchange="app.filterByStatus(this.value)" style="width: 150px;">
                            <option value="all">Todos los estados</option>
                            <option value="visible">Solo visibles</option>
                            <option value="hidden">Solo ocultos</option>
                        </select>
                        <input type="number" id="min-price" placeholder="Precio mínimo" style="width: 120px;" onchange="app.filterByPrice()">
                        <input type="number" id="max-price" placeholder="Precio máximo" style="width: 120px;" onchange="app.filterByPrice()">
                        <select id="sort-by" onchange="app.sortItems(this.value)" style="width: 150px;">
                            <option value="name">Ordenar por nombre</option>
                            <option value="price">Ordenar por precio</option>
                            <option value="created">Ordenar por fecha</option>
                        </select>
                        <button onclick="app.clearFilters()" class="btn btn-blue" style="width: auto;">Limpiar Filtros</button>
                    </div>
                    
                    <div class="admin-controls">
                        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
                            <input type="text" id="new-category-name" placeholder="Crear nueva categoría..." style="flex-grow: 1;">
                            <button class="btn btn-green" onclick="app.addCategory()">Crear Categoría</button>
                            <button class="btn btn-blue" onclick="app.openAddProductModal()">
                                <i class="ph ph-plus-circle"></i> Agregar Producto
                            </button>
                        </div>
                        
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <button class="btn btn-blue" onclick="app.toggleHiddenFilter(this)" style="flex-grow: 0; width: auto;">${this.showHiddenInAdmin ? 'Ocultar Ocultos' : 'Mostrar Ocultos'}</button>
                            <button class="btn ${this.hidePrices ? 'btn-red' : 'btn-green'}" onclick="app.togglePrices(this)" style="flex-grow: 0; width: auto;">${this.hidePrices ? 'Mostrar Precios' : 'Ocultar Precios'}</button>
                        </div>
                    </div>
                    <div id="categories-container"></div>`;
                const container = this.nodes.adminView.querySelector('#categories-container');
                this.menuData.forEach(category => {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = `menu-category ${category.hidden ? 'is-hidden' : ''}`;
                    categoryDiv.dataset.id = category.id;
                    let itemsHtml = '';
                    category.items.forEach(item => {
                        const lastModified = item.updatedAt ? new Date(item.updatedAt).toLocaleDateString('es-AR') : 'N/A';
                        itemsHtml += `<div class="menu-item ${item.hidden ? 'is-hidden' : ''}" data-id="${item.id}">
                            <i class="ph-fill ph-dots-six-vertical draggable-handle text-2xl"></i>
                            <div class="menu-item-inputs">
                                <input type="text" value="${item.name || ''}" onchange="app.updateItem('${item.id}', 'name', this.value)" placeholder="Nombre del plato">
                                <textarea oninput="app.autoResizeTextarea(this); app.updateItem('${item.id}', 'description', this.value)" placeholder="Descripción del plato">${item.description || ''}</textarea>
                                <small style="color: #666; font-size: 0.8em;">Última modificación: ${lastModified}</small>
                            </div>
                            <div class="menu-item-actions">
                                <div style="display: flex; flex-direction: column; gap: 5px;">
                                    <input type="number" value="${item.price || 0}" onchange="app.updateItem('${item.id}', 'price', Number(this.value))" style="width: 100px; text-align: right;" placeholder="Precio" min="0">
                                    <div style="display: flex; gap: 2px;">
                                        <input type="number" value="${item.discountValue || 0}" onchange="app.updateItem('${item.id}', 'discountValue', Number(this.value))" style="width: 80px; text-align: right;" placeholder="Descuento" min="0" title="Valor del descuento">
                                        <select onchange="app.updateItem('${item.id}', 'discountType', this.value)" style="width: 30px; padding: 2px;">
                                            <option value="percentage" ${(item.discountType || 'percentage') === 'percentage' ? 'selected' : ''}>%</option>
                                            <option value="pesos" ${(item.discountType || 'percentage') === 'pesos' ? 'selected' : ''}>$</option>
                                        </select>
                                    </div>
                                    <div style="display: flex; gap: 5px;">
                                        <button class="btn-icon" onclick="app.updateItem('${item.id}', 'hidden', ${!item.hidden})" title="${item.hidden ? 'Mostrar' : 'Ocultar'}">${item.hidden ? this.icons.hidden : this.icons.visible}</button>
                                        <button class="btn-icon ${item.premium ? 'premium-active' : ''}" onclick="app.updateItem('${item.id}', 'premium', ${!item.premium})" title="${item.premium ? 'Quitar Premium' : 'Marcar Premium'}" style="${item.premium ? 'background-color: #ffd700; color: #8b4513;' : ''}">⭐</button>
                                        <button class="btn-icon" onclick="app.duplicateItem('${item.id}')" title="Duplicar plato">${this.icons.duplicate}</button>
                                        <button class="btn btn-red" onclick="app.deleteItem('${item.id}')" style="padding: 8px 12px;" title="Eliminar">X</button>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    });
                    categoryDiv.innerHTML = `
                        <div class="category-header">
                            <i class="ph-fill ph-dots-six-vertical draggable-handle text-2xl"></i>
                            <input type="text" value="${category.name || ''}" onchange="app.updateCategory('${category.id}', 'name', this.value)">
                            <div class="category-actions">
                                <button class="btn-icon" onclick="app.updateCategory('${category.id}', 'hidden', ${!category.hidden})">${category.hidden ? this.icons.hidden : this.icons.visible}</button>
                                <button class="btn btn-red" onclick="app.deleteCategory('${category.id}')" style="margin-left: 10px;">Eliminar</button>
                            </div>
                        </div>
                        <div class="items-container" data-category-id="${category.id}">${itemsHtml}</div>`;
                    container.appendChild(categoryDiv);
                });
                this.nodes.adminView.classList.toggle('hide-hidden-items', !this.showHiddenInAdmin);
                this.initDragAndDrop();
                
                // Inicializar auto-resize en todos los textareas
                setTimeout(() => {
                    this.nodes.adminView.querySelectorAll('textarea').forEach(textarea => {
                        this.autoResizeTextarea(textarea);
                    });
                }, 100);
            },
            
            openLoginModal() { this.nodes.loginModal.classList.remove('hidden', 'flex'); this.nodes.loginModal.classList.add('flex'); },
            closeLoginModal() { this.nodes.loginModal.classList.add('hidden'); this.nodes.loginModal.classList.remove('flex'); },

            async handleLogin(e) {
                e.preventDefault();
                if (this.nodes.loginModal.querySelector('#admin-password').value === 'facu') {
                    this.isAdmin = true;
                    this.closeLoginModal();
                    this.render();
                } else {
                    this.nodes.loginModal.querySelector('#admin-login-error').textContent = 'Contraseña incorrecta.';
                }
            },
            async logout() { this.isAdmin = false; this.render(); },
            toggleHiddenFilter(button) {
                this.showHiddenInAdmin = !this.showHiddenInAdmin;
                button.textContent = this.showHiddenInAdmin ? 'Ocultar Ocultos' : 'Mostrar Ocultos';
                this.nodes.adminView.classList.toggle('hide-hidden-items', !this.showHiddenInAdmin);
            },
            
            async togglePrices(button) {
                this.hidePrices = !this.hidePrices;
                button.textContent = this.hidePrices ? 'Mostrar Precios' : 'Ocultar Precios';
                button.className = `btn ${this.hidePrices ? 'btn-red' : 'btn-green'}`;
                
                // Guardar configuración en localStorage (independiente por instancia)
                localStorage.setItem('hidePrices', this.hidePrices.toString());
                
                // Actualizar vista pública si está visible
                if (!this.isAdmin) {
                    this.renderPublicView();
                }
                
                this.showToast(`Precios ${this.hidePrices ? 'ocultados' : 'mostrados'}`, 'success');
            },
            
            // Funciones de búsqueda y filtros
            searchItems(query) {
                this.searchQuery = query.toLowerCase();
                this.applyFilters();
            },
            
            filterByStatus(status) {
                this.statusFilter = status;
                this.applyFilters();
            },
            
            filterByPrice() {
                const minPrice = document.getElementById('min-price').value;
                const maxPrice = document.getElementById('max-price').value;
                this.priceFilter = {
                    min: minPrice ? Number(minPrice) : 0,
                    max: maxPrice ? Number(maxPrice) : 999999
                };
                this.applyFilters();
            },
            
            sortItems(sortBy) {
                this.sortBy = sortBy;
                this.applyFilters();
            },
            
            clearFilters() {
                this.searchQuery = '';
                this.statusFilter = 'all';
                this.priceFilter = { min: 0, max: 999999 };
                this.sortBy = 'name';
                
                // Limpiar inputs
                document.getElementById('search-input').value = '';
                document.getElementById('status-filter').value = 'all';
                document.getElementById('min-price').value = '';
                document.getElementById('max-price').value = '';
                document.getElementById('sort-by').value = 'name';
                
                // Restaurar datos originales
                this.menuData = JSON.parse(JSON.stringify(this.originalMenuData));
                this.renderAdminView();
                this.showToast('Filtros limpiados', 'info');
            },
            
            applyFilters() {
                // Restaurar datos originales
                let filteredData = JSON.parse(JSON.stringify(this.originalMenuData));
                
                // Aplicar búsqueda
                if (this.searchQuery) {
                    filteredData = filteredData.map(category => ({
                        ...category,
                        items: category.items.filter(item => 
                            item.name.toLowerCase().includes(this.searchQuery) ||
                            item.description.toLowerCase().includes(this.searchQuery) ||
                            category.name.toLowerCase().includes(this.searchQuery)
                        )
                    })).filter(category => category.items.length > 0);
                }
                
                // Aplicar filtro de estado
                if (this.statusFilter !== 'all') {
                    filteredData = filteredData.map(category => ({
                        ...category,
                        items: category.items.filter(item => 
                            this.statusFilter === 'visible' ? !item.hidden : item.hidden
                        )
                    })).filter(category => category.items.length > 0);
                }
                
                // Aplicar filtro de precio
                filteredData = filteredData.map(category => ({
                    ...category,
                    items: category.items.filter(item => 
                        (item.price || 0) >= this.priceFilter.min && 
                        (item.price || 0) <= this.priceFilter.max
                    )
                })).filter(category => category.items.length > 0);
                
                // Aplicar ordenamiento
                filteredData.forEach(category => {
                    category.items.sort((a, b) => {
                        let aVal, bVal;
                        switch (this.sortBy) {
                            case 'name':
                                aVal = a.name.toLowerCase();
                                bVal = b.name.toLowerCase();
                                break;
                            case 'price':
                                aVal = a.price || 0;
                                bVal = b.price || 0;
                                break;
                            case 'created':
                                aVal = a.createdAt || 0;
                                bVal = b.createdAt || 0;
                                break;
                            default:
                                aVal = a.name.toLowerCase();
                                bVal = b.name.toLowerCase();
                        }
                        
                        if (aVal < bVal) return -1;
                        if (aVal > bVal) return 1;
                        return 0;
                    });
                });
                
                this.menuData = filteredData;
                this.renderAdminView();
            },
            
            // Modo oscuro
            async toggleDarkMode() {
                this.darkMode = !this.darkMode;
                document.body.classList.toggle('dark-mode', this.darkMode);
                
                // Guardar configuración localmente (personalizado por dispositivo)
                localStorage.setItem('darkMode', this.darkMode.toString());
                
                // Solo actualizar la vista actual sin re-renderizar todo
                if (this.isAdmin) {
                    // En modo admin, solo actualizar los estilos sin re-renderizar
                    this.updateDarkModeStyles();
                } else {
                    // En modo público, solo actualizar la vista pública
                    this.renderPublicView();
                }
                
                this.showToast(`Modo ${this.darkMode ? 'oscuro' : 'claro'} activado`, 'success');
            },
            
            // Función auxiliar para actualizar estilos en modo oscuro sin re-renderizar
            updateDarkModeStyles() {
                // Esta función se puede expandir si es necesario para actualizar estilos específicos
                // Por ahora, solo los estilos CSS se encargan del cambio
            },
            
            // Exportar menú
            exportMenu() {
                const menuData = {
                    categories: this.menuData.map(cat => ({
                        id: cat.id,
                        name: cat.name,
                        order: cat.order,
                        hidden: cat.hidden,
                        items: cat.items.map(item => ({
                            id: item.id,
                            name: item.name,
                            description: item.description,
                            price: item.price,
                            discountValue: item.discountValue || 0,
                            discountType: item.discountType || 'percentage',
                            hidden: item.hidden,
                            premium: item.premium,
                            order: item.order,
                            categoryId: item.categoryId
                        }))
                    })),
                    settings: {
                        hidePrices: this.hidePrices,
                        exportDate: new Date().toISOString()
                    }
                };
                
                const dataStr = JSON.stringify(menuData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `menu-los-nogales-${new Date().toISOString().split('T')[0]}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                this.showToast('Menú exportado exitosamente', 'success');
            },
            
            exportToPDF() {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    // Configuración inicial
                    doc.setFont('helvetica');
                    doc.setFontSize(20);
                    
                    // Título principal
                    doc.text('Parrilla Los Nogales', 105, 20, { align: 'center' });
                    
                    // Logo (si está disponible)
                    // doc.addImage(logoData, 'PNG', 15, 10, 30, 30);
                    
                    doc.setFontSize(12);
                    doc.text(`Generado el: ${new Date().toLocaleDateString('es-AR')}`, 105, 30, { align: 'center' });
                    
                    let yPosition = 45;
                    const pageHeight = doc.internal.pageSize.height;
                    const margin = 20;
                    
                    // Iterar por categorías
                    this.menuData
                        .filter(category => !category.hidden)
                        .forEach(category => {
                            // Verificar si necesitamos nueva página
                            if (yPosition > pageHeight - 50) {
                                doc.addPage();
                                yPosition = 20;
                            }
                            
                            // Título de categoría
                            doc.setFontSize(16);
                            doc.setFont('helvetica', 'bold');
                            doc.text(category.name, margin, yPosition);
                            yPosition += 10;
                            
                            // Línea divisoria
                            doc.setDrawColor(200, 200, 200);
                            doc.line(margin, yPosition, 190, yPosition);
                            yPosition += 8;
                            
                            // Items de la categoría
                            const visibleItems = category.items.filter(item => !item.hidden);
                            
                            if (visibleItems.length === 0) {
                                doc.setFontSize(10);
                                doc.setFont('helvetica', 'normal');
                                doc.text('No hay productos disponibles', margin + 5, yPosition);
                                yPosition += 15;
                            } else {
                                visibleItems.forEach(item => {
                                    // Verificar si necesitamos nueva página
                                    if (yPosition > pageHeight - 30) {
                                        doc.addPage();
                                        yPosition = 20;
                                    }
                                    
                                    doc.setFontSize(12);
                                    doc.setFont('helvetica', 'bold');
                                    
                                    // Nombre del producto
                                    let itemText = item.name;
                                    // Removemos la estrella del nombre para evitar duplicación con el indicador premium
                                    doc.text(itemText, margin, yPosition);
                                    
                                    // Precio (si no está oculto)
                                    if (!this.hidePrices) {
                                        let priceText = `$${item.price.toLocaleString('es-AR')}`;
                                        if (item.discountValue && item.discountValue > 0) {
                                            const discountedPrice = this.calculateDiscountedPrice(item.price, item.discountValue, item.discountType || 'percentage');
                                            const discountText = item.discountType === 'percentage' ? `-${item.discountValue}%` : `-$${item.discountValue.toLocaleString('es-AR')}`;
                                            priceText = `$${item.price.toLocaleString('es-AR')} → $${discountedPrice.toFixed(0)} (${discountText})`;
                                        }
                                        doc.text(priceText, 160, yPosition, { align: 'right' });
                                    }
                                    
                                    yPosition += 6;
                                    
                                    // Descripción (si existe)
                                    if (item.description && item.description.trim()) {
                                        doc.setFontSize(10);
                                        doc.setFont('helvetica', 'italic');
                                        doc.text(item.description, margin + 5, yPosition, { maxWidth: 140 });
                                        yPosition += 8;
                                    }
                                    
                                    yPosition += 5;
                                });
                            }
                            
                            yPosition += 10;
                        });
                    
                    // Pie de página
                    const totalPages = doc.internal.getNumberOfPages();
                    for (let i = 1; i <= totalPages; i++) {
                        doc.setPage(i);
                        doc.setFontSize(8);
                        doc.setFont('helvetica', 'normal');
                        doc.text(`Página ${i} de ${totalPages}`, 105, pageHeight - 10, { align: 'center' });
                    }
                    
                    // Guardar PDF
                    const fileName = `menu-los-nogales-${new Date().toISOString().split('T')[0]}.pdf`;
                    doc.save(fileName);
                    
                    this.showToast('PDF generado exitosamente', 'success');
                    
                } catch (error) {
                    console.error('Error al generar PDF:', error);
                    this.showToast('Error al generar el PDF', 'error');
                }
            },
            
            initDragAndDrop() {
                const categoriesContainer = this.nodes.adminView.querySelector('#categories-container');
                if (categoriesContainer) {
                    Sortable.create(categoriesContainer, {
                        handle: '.draggable-handle', animation: 1000,
                        onEnd: async (evt) => {
                            this.menuData.splice(evt.newIndex, 0, this.menuData.splice(evt.oldIndex, 1)[0]);
                            const batch = db.batch();
                            this.menuData.forEach((cat, index) => batch.update(db.collection('menuCategories').doc(cat.id), { order: index }));
                            await batch.commit();
                        },
                    });
                }
                this.nodes.adminView.querySelectorAll('.items-container').forEach(container => {
                    Sortable.create(container, {
                        handle: '.draggable-handle', animation: 1000,
                        onEnd: async (evt) => {
                            const categoryId = evt.from.dataset.categoryId;
                            const category = this.menuData.find(c => c.id === categoryId);
                            if (!category) return;
                            category.items.splice(evt.newIndex, 0, category.items.splice(evt.oldIndex, 1)[0]);
                            const batch = db.batch();
                            category.items.forEach((item, index) => batch.update(db.collection('menu').doc(item.id), { order: index }));
                            await batch.commit();
                        },
                    });
                });
            },
            
            // --- ✅ INICIO DE FUNCIONES OPTIMIZADAS ---
            
            addCategory() {
                const input = document.getElementById('new-category-name');
                const name = input.value.trim();
                
                // Validar datos
                const validation = this.validateCategoryData(name);
                if (!validation.isValid) {
                    this.showValidationErrors(validation.errors);
                    return;
                }
                
                // Verificar si ya existe una categoría con ese nombre
                const existingCategory = this.menuData.find(cat => 
                    cat.name.toLowerCase() === name.toLowerCase()
                );
                if (existingCategory) {
                    this.showToast('❌ Ya existe una categoría con ese nombre', 'error');
                    return;
                }
                
                const newCategory = {
                    name: name,
                    order: this.menuData.length,
                    hidden: false
                };
                
                db.collection('menuCategories').add(newCategory).then(docRef => {
                    newCategory.id = docRef.id;
                    this.menuData.push(newCategory);
                    this.originalMenuData = JSON.parse(JSON.stringify(this.menuData));
                    this.render();
                    
                    // Limpiar input inmediatamente
                    input.value = '';
                    
                    this.showToast(`✅ Categoría "${name}" creada exitosamente`, 'success');
                    
                    // Enfocar en el input de la nueva categoría para agregar productos
                    setTimeout(() => {
                        const newCategoryInput = document.querySelector(`[data-category-id="${docRef.id}"] input[type="text"]`);
                        if (newCategoryInput) {
                            newCategoryInput.focus();
                        }
                    }, 100);
                    
                }).catch(error => {
                    console.error('Error al crear categoría:', error);
                    this.showToast('❌ Error al crear la categoría', 'error');
                });
            },

            async deleteCategory(categoryId) {
                if (!confirm('¿Seguro? Se borrarán todos los platos de esta categoría.')) return;
                
                const catIndex = this.menuData.findIndex(c => c.id === categoryId);
                if (catIndex === -1) return;

                const itemsToDelete = this.menuData[catIndex].items || [];
                this.menuData.splice(catIndex, 1); // Lo borramos de la vista al instante
                this.render(); 
                
                // Borramos de la base de datos en segundo plano
                const batch = db.batch();
                itemsToDelete.forEach(item => batch.delete(db.collection('menu').doc(item.id)));
                batch.delete(db.collection('menuCategories').doc(categoryId));
                await batch.commit();
            },

            async updateCategory(categoryId, field, value) {
                // Actualizamos el dato localmente
                const category = this.menuData.find(c => c.id === categoryId);
                if(category) {
                    category[field] = value;
                }
                this.render(); // Actualizamos la vista al instante
                
                // Enviamos el cambio a la base de datos en segundo plano
                await db.collection('menuCategories').doc(categoryId).update({ [field]: value });
            },
            
            async addItem(categoryId) {
                const category = this.menuData.find(c => c.id === categoryId);
                if (!category) return;
                
                const maxOrder = category.items.reduce((max, item) => Math.max(max, item.order || 0), -1);
                const newItemData = { name: 'Nuevo Plato', description: '', price: 0, hidden: false, premium: false, order: maxOrder + 1, categoryId: categoryId };
                
                const newItemRef = await db.collection('menu').add(newItemData);
                category.items.push({ ...newItemData, id: newItemRef.id }); // Añadimos el nuevo plato localmente
                this.render(); // Actualizamos la vista al instante
                
                setTimeout(() => {
                    const newField = document.querySelector(`.menu-item[data-id="${newItemRef.id}"] input[type="text"]`);
                    if (newField) { newField.focus(); newField.select(); }
                    
                    // Inicializar auto-resize en el nuevo textarea
                    const newTextarea = document.querySelector(`.menu-item[data-id="${newItemRef.id}"] textarea`);
                    if (newTextarea) {
                        this.autoResizeTextarea(newTextarea);
                    }
                }, 100);
            },

            async deleteItem(itemId) {
                if (!confirm('¿Eliminar este plato?')) return;
                
                // Buscamos y borramos el item localmente
                let catIndex, itemIndex;
                for (let i = 0; i < this.menuData.length; i++) {
                    let foundIndex = this.menuData[i].items.findIndex(item => item.id === itemId);
                    if (foundIndex !== -1) {
                        this.menuData[i].items.splice(foundIndex, 1);
                        break;
                    }
                }
                this.render(); // Actualizamos la vista al instante

                // Borramos de la base de datos en segundo plano
                await db.collection('menu').doc(itemId).delete();
            },

            async updateItem(itemId, field, value) {
                // Validación de precio
                if (field === 'price') {
                    if (!this.validatePrice(value)) {
                        this.showToast('El precio debe ser un número mayor o igual a 0', 'error');
                        return;
                    }
                }
                
                // Validación de descuento
                if (field === 'discountValue') {
                    const item = this.menuData.flatMap(cat => cat.items).find(i => i.id === itemId);
                    const discountType = item?.discountType || 'percentage';
                    
                    if (discountType === 'percentage') {
                        if (value < 0 || value > 100) {
                            this.showToast('El descuento debe estar entre 0 y 100%', 'error');
                            return;
                        }
                    } else {
                        if (value < 0) {
                            this.showToast('El descuento en pesos no puede ser negativo', 'error');
                            return;
                        }
                        if (item && value > item.price) {
                            this.showToast('El descuento en pesos no puede ser mayor al precio', 'error');
                            return;
                        }
                    }
                }
                
                // Actualizamos el dato localmente
                for (let category of this.menuData) {
                    let item = category.items.find(i => i.id === itemId);
                    if (item) {
                        item[field] = value;
                        item.updatedAt = new Date().toISOString();
                        break;
                    }
                }
                this.render(); // Actualizamos la vista al instante

                // Enviamos el cambio a la base de datos en segundo plano
                try {
                    await db.collection('menu').doc(itemId).update({ 
                        [field]: value,
                        updatedAt: new Date().toISOString()
                    });
                    this.showToast('Cambio guardado', 'success');
                } catch (error) {
                    this.showToast('Error al guardar el cambio', 'error');
                    console.error('Error:', error);
                }
            },
            
            // Función para duplicar platos
            async duplicateItem(itemId) {
                try {
                    let originalItem = null;
                    let categoryId = null;
                    
                    // Buscar el item original
                    for (let category of this.menuData) {
                        let item = category.items.find(i => i.id === itemId);
                        if (item) {
                            originalItem = item;
                            categoryId = category.id;
                            break;
                        }
                    }
                    
                    if (!originalItem) {
                        this.showToast('No se encontró el plato a duplicar', 'error');
                        return;
                    }
                    
                    const maxOrder = this.menuData.find(c => c.id === categoryId).items.reduce((max, item) => Math.max(max, item.order || 0), -1);
                    const newItemData = {
                        name: `${originalItem.name} (Copia)`,
                        description: originalItem.description,
                        price: originalItem.price,
                        discountValue: originalItem.discountValue || 0,
                        discountType: originalItem.discountType || 'percentage',
                        hidden: originalItem.hidden,
                        premium: originalItem.premium || false,
                        order: maxOrder + 1,
                        categoryId: categoryId,
                        createdAt: new Date().toISOString()
                    };
                    
                    const newItemRef = await db.collection('menu').add(newItemData);
                    const category = this.menuData.find(c => c.id === categoryId);
                    category.items.push({ ...newItemData, id: newItemRef.id });
                    this.originalMenuData = JSON.parse(JSON.stringify(this.menuData));
                    this.render();
                    
                    this.showToast('Plato duplicado exitosamente', 'success');
                } catch (error) {
                    this.showToast('Error al duplicar el plato', 'error');
                    console.error('Error:', error);
                }
            },
            
            // Funciones de validación
            validateItemData(name, price, description) {
                const errors = [];
                
                if (!name || name.trim().length < 2) {
                    errors.push('El nombre debe tener al menos 2 caracteres');
                }
                if (name && name.trim().length > 50) {
                    errors.push('El nombre no puede exceder 50 caracteres');
                }
                if (price < 0 || price > 999999) {
                    errors.push('El precio debe estar entre 0 y 999,999');
                }
                if (description && description.trim().length > 200) {
                    errors.push('La descripción no puede exceder 200 caracteres');
                }
                
                return {
                    isValid: errors.length === 0,
                    errors: errors
                };
            },
            
            validateCategoryData(name) {
                const errors = [];
                
                if (!name || name.trim().length < 2) {
                    errors.push('El nombre de la categoría debe tener al menos 2 caracteres');
                }
                if (name && name.trim().length > 30) {
                    errors.push('El nombre de la categoría no puede exceder 30 caracteres');
                }
                
                return {
                    isValid: errors.length === 0,
                    errors: errors
                };
            },
            
            showValidationErrors(errors) {
                const errorMessage = errors.join('\n• ');
                this.showToast(`❌ Errores de validación:\n• ${errorMessage}`, 'error');
            },
            
            // Funciones para el modal de productos
            openAddProductModal() {
                const modal = document.getElementById('add-product-modal');
                const categorySelect = document.getElementById('modal-product-category');
                
                // Poblar dropdown de categorías
                if (categorySelect) {
                    categorySelect.innerHTML = '<option value="">Seleccionar categoría</option>';
                    this.menuData
                        .filter(cat => !cat.hidden)
                        .forEach(category => {
                            const option = document.createElement('option');
                            option.value = category.id;
                            option.textContent = category.name;
                            categorySelect.appendChild(option);
                        });
                }
                
                // Mostrar modal
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                
                // Enfocar en el primer campo
                setTimeout(() => {
                    document.getElementById('modal-product-name').focus();
                }, 100);
            },
            
            closeAddProductModal() {
                const modal = document.getElementById('add-product-modal');
                const form = document.getElementById('add-product-form');
                
                // Ocultar modal
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                
                // Limpiar formulario
                if (form) {
                    form.reset();
                }
            },
            
            async handleAddProductForm(e) {
                e.preventDefault();
                
                const name = document.getElementById('modal-product-name').value.trim();
                const description = document.getElementById('modal-product-description').value.trim();
                const price = Number(document.getElementById('modal-product-price').value);
                const discountValue = Number(document.getElementById('modal-product-discount').value || 0);
                const discountType = document.getElementById('modal-product-discount-type').value;
                const categoryId = document.getElementById('modal-product-category').value;
                const premium = document.getElementById('modal-product-premium').checked;
                
                // Validar datos
                const validation = this.validateItemData(name, price, description);
                if (!validation.isValid) {
                    this.showValidationErrors(validation.errors);
                    return;
                }
                
                if (!categoryId) {
                    this.showToast('❌ Debes seleccionar una categoría', 'error');
                    document.getElementById('modal-product-category').focus();
                    return;
                }
                
                // Validar descuento según el tipo
                if (discountType === 'percentage') {
                    if (discountValue < 0 || discountValue > 100) {
                        this.showToast('❌ El descuento debe ser entre 0 y 100%', 'error');
                        document.getElementById('modal-product-discount').focus();
                        return;
                    }
                } else {
                    if (discountValue < 0 || discountValue > price) {
                        this.showToast('❌ El descuento en pesos no puede ser mayor al precio', 'error');
                        document.getElementById('modal-product-discount').focus();
                        return;
                    }
                }
                
                const category = this.menuData.find(c => c.id === categoryId);
                if (!category) {
                    this.showToast('❌ Categoría no encontrada', 'error');
                    return;
                }
                
                const maxOrder = category.items.reduce((max, item) => Math.max(max, item.order || 0), -1);
                const newItemData = { 
                    name: name, 
                    description: description, 
                    price: price, 
                    discountValue: discountValue,
                    discountType: discountType,
                    hidden: false, 
                    premium: premium, 
                    order: maxOrder + 1, 
                    categoryId: categoryId 
                };
                
                try {
                    const newItemRef = await db.collection('menu').add(newItemData);
                    category.items.push({ ...newItemData, id: newItemRef.id });
                    this.originalMenuData = JSON.parse(JSON.stringify(this.menuData));
                    this.render();
                    
                    this.closeAddProductModal();
                    this.showToast(`✅ "${name}" agregado a "${category.name}"`, 'success');
                    
                } catch (error) {
                    this.showToast('❌ Error al agregar el producto', 'error');
                    console.error('Error:', error);
                }
            },
            
            // Funciones para el sistema de encuestas
            openSurveyResultsModal() {
                document.getElementById('surveyResultsModal').style.display = 'block';
                this.loadSurveyResults();
            },

            closeSurveyResultsModal() {
                document.getElementById('surveyResultsModal').style.display = 'none';
            },

            loadSurveyResults() {
                const container = document.getElementById('surveyResultsContent');
                const allResults = JSON.parse(localStorage.getItem('allSurveyResults') || '[]');
                const customerContacts = JSON.parse(localStorage.getItem('customerContacts') || '[]');
                const customerSurveys = JSON.parse(localStorage.getItem('customerSurveys') || '[]');
                
                if (allResults.length === 0 && customerContacts.length === 0 && customerSurveys.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #A6A6A6;">No hay datos disponibles.</p>';
                    return;
                }
                
                let html = '<div class="survey-results">';
                
                // Mostrar datos de contacto de clientes
                if (customerContacts.length > 0) {
                    const contactStats = this.generateContactStats(customerContacts);
                    
                    html += `
                        <div class="survey-item">
                            <div class="survey-title">📋 Registros de Contacto de Clientes</div>
                            <div class="survey-stats">
                                <div class="stat-item">
                                    <div class="stat-value">${contactStats.totalContacts}</div>
                                    <div class="stat-label">Total Contactos</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">${contactStats.todayContacts}</div>
                                    <div class="stat-label">Hoy</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">${contactStats.mobileContacts}</div>
                                    <div class="stat-label">Desde Móvil</div>
                                </div>
                            </div>
                            <div class="responses-list">
                                ${customerContacts.map(contact => `
                                    <div class="response-item">
                                        <div class="response-date">${new Date(contact.createdAt).toLocaleString()}</div>
                                        <div class="response-data">
                                            <strong>Nombre:</strong> ${contact.name} | 
                                            <strong>Teléfono:</strong> ${contact.phone}
                                            <br><strong>Dispositivo:</strong> ${contact.deviceType}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                
                // Mostrar encuestas completas de clientes (customerSurveys)
                if (customerSurveys.length > 0) {
                    const surveyStats = this.generateCustomerSurveyStats(customerSurveys);
                    
                    html += `
                        <div class="survey-item">
                            <div class="survey-title">📊 Encuestas de Satisfacción Completas</div>
                            <div class="survey-stats">
                                <div class="stat-item">
                                    <div class="stat-value">${surveyStats.totalSurveys}</div>
                                    <div class="stat-label">Total Encuestas</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">${surveyStats.averageRating}</div>
                                    <div class="stat-label">Promedio General</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">${surveyStats.commentsCount}</div>
                                    <div class="stat-label">Con Comentarios</div>
                                </div>
                            </div>
                            <div class="responses-list">
                                ${customerSurveys.map(survey => `
                                    <div class="response-item">
                                        <div class="response-date">${new Date(survey.createdAt).toLocaleString()}</div>
                                        <div class="response-data">
                                            <strong>Cliente:</strong> ${survey.customerName} | 
                                            <strong>Teléfono:</strong> ${survey.customerPhone} | 
                                            <strong>Mozo:</strong> ${survey.waiterName}
                                            <br><strong>Calidad Platos:</strong> ${survey.question1}/5 | 
                                            <strong>Servicio:</strong> ${survey.question2}/5 | 
                                            <strong>Recomendación:</strong> ${survey.question3}/5
                                            ${survey.comments ? `<br><strong>Comentario:</strong> ${survey.comments}` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                
                // Mostrar resultados de encuestas tradicionales (si existen)
                if (allResults.length > 0) {
                    // Agrupar resultados por encuesta
                    const surveys = {};
                    allResults.forEach(result => {
                        if (!surveys[result.surveyId]) {
                            surveys[result.surveyId] = [];
                        }
                        surveys[result.surveyId].push(result);
                    });
                    
                    Object.keys(surveys).forEach(surveyId => {
                        const results = surveys[surveyId];
                        const stats = this.generateSurveyStats(results);
                        
                        html += `
                            <div class="survey-item">
                                <div class="survey-title">📊 ${results[0].surveyTitle}</div>
                                <div class="survey-stats">
                                    <div class="stat-item">
                                        <div class="stat-value">${stats.averageExperience}</div>
                                        <div class="stat-label">Promedio Experiencia</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-value">${stats.totalResponses}</div>
                                        <div class="stat-label">Total Respuestas</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-value">${stats.commentsCount}</div>
                                        <div class="stat-label">Con Comentarios</div>
                                    </div>
                                </div>
                                <div class="responses-list">
                                    ${results.map(result => `
                                        <div class="response-item">
                                            <div class="response-date">${new Date(result.submittedAt).toLocaleString()}</div>
                                            <div class="response-data">
                                                <strong>Experiencia:</strong> ${result.experience}/5 | 
                                                <strong>Recomendación:</strong> ${result.recommendation}
                                                ${result.improvements ? `<br><strong>Comentario:</strong> ${result.improvements}` : ''}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    });
                }
                
                html += '</div>';
                container.innerHTML = html;
            },

            generateContactStats(contacts) {
                const today = new Date().toDateString();
                const todayContacts = contacts.filter(c => new Date(c.createdAt).toDateString() === today).length;
                const mobileContacts = contacts.filter(c => c.deviceType === 'Móvil').length;
                
                return {
                    totalContacts: contacts.length,
                    todayContacts,
                    mobileContacts
                };
            },

            generateSurveyStats(results) {
                const experiences = results.map(r => parseInt(r.experience)).filter(e => !isNaN(e));
                const averageExperience = experiences.length > 0 ? (experiences.reduce((a, b) => a + b, 0) / experiences.length).toFixed(1) : '0';
                const commentsCount = results.filter(r => r.improvements && r.improvements.trim()).length;
                
                return {
                    averageExperience,
                    totalResponses: results.length,
                    commentsCount
                };
            },

            generateCustomerSurveyStats(surveys) {
                const allRatings = [];
                surveys.forEach(survey => {
                    allRatings.push(parseInt(survey.question1), parseInt(survey.question2), parseInt(survey.question3));
                });
                
                const validRatings = allRatings.filter(r => !isNaN(r));
                const averageRating = validRatings.length > 0 ? (validRatings.reduce((a, b) => a + b, 0) / validRatings.length).toFixed(1) : '0';
                const commentsCount = surveys.filter(s => s.comments && s.comments.trim()).length;
                
                return {
                    totalSurveys: surveys.length,
                    averageRating,
                    commentsCount
                };
            },

            exportSurveyResults() {
                const allResults = JSON.parse(localStorage.getItem('allSurveyResults') || '[]');
                const customerContacts = JSON.parse(localStorage.getItem('customerContacts') || '[]');
                const customerSurveys = JSON.parse(localStorage.getItem('customerSurveys') || '[]');
                
                if (allResults.length === 0 && customerContacts.length === 0 && customerSurveys.length === 0) {
                    this.showToast('❌ No hay datos para exportar', 'error');
                    return;
                }
                
                // Crear CSV
                let csv = 'Tipo,Fecha,Nombre,Teléfono,Mozo,Calidad Platos,Servicio,Recomendación,Comentarios,Dispositivo\n';
                
                // Agregar datos de contacto
                customerContacts.forEach(contact => {
                    const date = new Date(contact.createdAt).toLocaleString();
                    const name = (contact.name || '').replace(/"/g, '""');
                    const phone = (contact.phone || '').replace(/"/g, '""');
                    const device = (contact.deviceType || '').replace(/"/g, '""');
                    
                    csv += `"Contacto","${date}","${name}","${phone}","","","","","","${device}"\n`;
                });
                
                // Agregar encuestas completas de clientes
                customerSurveys.forEach(survey => {
                    const date = new Date(survey.createdAt).toLocaleString();
                    const name = (survey.customerName || '').replace(/"/g, '""');
                    const phone = (survey.customerPhone || '').replace(/"/g, '""');
                    const waiter = (survey.waiterName || '').replace(/"/g, '""');
                    const quality = survey.question1 || '';
                    const service = survey.question2 || '';
                    const recommendation = survey.question3 || '';
                    const comments = (survey.comments || '').replace(/"/g, '""');
                    const device = (survey.deviceType || '').replace(/"/g, '""');
                    
                    csv += `"Encuesta Completa","${date}","${name}","${phone}","${waiter}","${quality}","${service}","${recommendation}","${comments}","${device}"\n`;
                });
                
                // Agregar resultados de encuestas tradicionales
                allResults.forEach(result => {
                    const date = new Date(result.submittedAt).toLocaleString();
                    const experience = result.experience || '';
                    const recommendation = result.recommendation || '';
                    const improvements = (result.improvements || '').replace(/"/g, '""');
                    
                    csv += `"Encuesta Tradicional","${date}","","","","","","${experience}","${improvements}",""\n`;
                });
                
                // Descargar archivo
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'datos_clientes_y_encuestas.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                this.showToast('✅ Datos exportados correctamente', 'success');
            },

            clearSurveyResults() {
                if (confirm('¿Estás seguro de que quieres eliminar todos los datos (encuestas y contactos de clientes)? Esta acción no se puede deshacer.')) {
                    // Eliminar todos los resultados de encuestas tradicionales
                    const allResults = JSON.parse(localStorage.getItem('allSurveyResults') || '[]');
                    allResults.forEach(result => {
                        localStorage.removeItem('surveyResults_' + result.surveyId);
                    });
                    localStorage.removeItem('allSurveyResults');
                    
                    // Eliminar todos los contactos de clientes
                    localStorage.removeItem('customerContacts');
                    
                    // Eliminar todas las encuestas completas de clientes
                    localStorage.removeItem('customerSurveys');
                    
                    // Recargar resultados
                    this.loadSurveyResults();
                    this.showToast('✅ Todos los datos han sido eliminados', 'success');
                }
            },

            // Funciones para el sistema de estadísticas de visitas
            openStatisticsModal() {
                document.getElementById('statisticsModal').style.display = 'block';
                this.loadStatistics();
            },

            // Obtener estadísticas rápidas para mostrar en el panel de administrador
            async getQuickStats() {
                try {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    const todaySnapshot = await db.collection('websiteVisits')
                        .where('timestamp', '>=', today.toISOString())
                        .get();
                    
                    const totalSnapshot = await db.collection('websiteVisits').get();
                    
                    return {
                        todayVisits: todaySnapshot.size,
                        totalVisits: totalSnapshot.size
                    };
                } catch (error) {
                    console.error('Error al obtener estadísticas rápidas:', error);
                    return { todayVisits: 0, totalVisits: 0 };
                }
            },

            closeStatisticsModal() {
                document.getElementById('statisticsModal').style.display = 'none';
            },

            // Migrar datos existentes del localStorage a Firebase
            async migrateLocalVisitsToFirebase() {
                try {
                    const localVisits = JSON.parse(localStorage.getItem('websiteVisits') || '[]');
                    if (localVisits.length > 0) {
                        console.log(`Migrando ${localVisits.length} visitas del localStorage a Firebase...`);
                        
                        const batch = db.batch();
                        localVisits.forEach(visit => {
                            const docRef = db.collection('websiteVisits').doc();
                            batch.set(docRef, {
                                ...visit,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                migrated: true
                            });
                        });
                        
                        await batch.commit();
                        console.log('Migración completada exitosamente');
                        
                        // Limpiar localStorage después de la migración
                        localStorage.removeItem('websiteVisits');
                    }
                } catch (error) {
                    console.error('Error al migrar visitas:', error);
                }
            },

            // Registrar una nueva visita
            async recordVisit() {
                try {
                    const visit = {
                        timestamp: new Date().toISOString(),
                        userAgent: navigator.userAgent,
                        referrer: document.referrer,
                        url: window.location.href,
                        screenSize: `${screen.width}x${screen.height}`,
                        language: navigator.language,
                        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    // Guardar en Firebase Firestore
                    await db.collection('websiteVisits').add(visit);
                    
                    // También mantener una copia local para acceso rápido (últimas 100 visitas)
                    const localVisits = JSON.parse(localStorage.getItem('websiteVisits') || '[]');
                    localVisits.push(visit);
                    
                    // Mantener solo las últimas 100 visitas en localStorage para acceso rápido
                    if (localVisits.length > 100) {
                        localVisits.splice(0, localVisits.length - 100);
                    }
                    
                    localStorage.setItem('websiteVisits', JSON.stringify(localVisits));
                    
                } catch (error) {
                    console.error('Error al registrar visita:', error);
                    // Fallback: guardar solo en localStorage si Firebase falla
                    const visit = {
                        timestamp: new Date().toISOString(),
                        userAgent: navigator.userAgent,
                        referrer: document.referrer,
                        url: window.location.href,
                        screenSize: `${screen.width}x${screen.height}`,
                        language: navigator.language,
                        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
                    };
                    
                    const visits = JSON.parse(localStorage.getItem('websiteVisits') || '[]');
                    visits.push(visit);
                    localStorage.setItem('websiteVisits', JSON.stringify(visits));
                }
            },

            async             loadStatistics() {
                const container = document.getElementById('statisticsContent');
                
                // Mostrar loading
                container.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="loading-spinner"></div><p>Cargando estadísticas...</p></div>';
                
                try {
                    // Cargar datos desde Firebase
                    const visitsSnapshot = await db.collection('websiteVisits')
                        .orderBy('createdAt', 'desc')
                        .limit(10000) // Limitar a las últimas 10,000 visitas para el análisis
                        .get();
                    
                    const visits = visitsSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                        timestamp: doc.data().timestamp || doc.data().createdAt?.toDate?.()?.toISOString() || new Date().toISOString()
                    }));
                    
                    if (visits.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: #A6A6A6;">No hay datos de visitas disponibles.</p>';
                        return;
                    }

                    // Filtrar solo las 2 URLs específicas
                    const allowedUrls = [
                        'https://parrillalosnogales.com/',
                        'https://cartaonline.netlify.app/'
                    ];
                    
                    const filteredVisits = visits.filter(visit => {
                        const visitUrl = visit.url || '';
                        return allowedUrls.some(allowedUrl => visitUrl.includes(allowedUrl));
                    });
                    
                    if (filteredVisits.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: #A6A6A6;">No hay datos de visitas para las URLs especificadas.</p>';
                        return;
                    }

                    // Separar visitas por URL
                    const parrillaVisits = filteredVisits.filter(visit => 
                        (visit.url || '').includes('parrillalosnogales.com')
                    );
                    
                    const netlifyVisits = filteredVisits.filter(visit => 
                        (visit.url || '').includes('cartaonline.netlify.app')
                    );

                    const stats = this.calculateVisitStatistics(filteredVisits);
                    const parrillaStats = this.calculateVisitStatistics(parrillaVisits);
                    const netlifyStats = this.calculateVisitStatistics(netlifyVisits);
                
                let html = `
                    <div class="statistics-container">
                        <div class="stats-overview">
                            <div class="stat-card">
                                <div class="stat-number">${stats.totalVisits}</div>
                                <div class="stat-label">Total de Visitas</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${stats.uniqueVisitors}</div>
                                <div class="stat-label">Visitantes Únicos</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${stats.todayVisits}</div>
                                <div class="stat-label">Visitas Hoy</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${stats.thisWeekVisits}</div>
                                <div class="stat-label">Esta Semana</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${stats.thisMonthVisits}</div>
                                <div class="stat-label">Este Mes</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${stats.thisYearVisits}</div>
                                <div class="stat-label">Este Año</div>
                            </div>
                        </div>

                        <div class="stats-details">
                            <div class="stats-section">
                                <h3>🌐 Estadísticas por Sitio Web</h3>
                                <div class="site-stats">
                                    <div class="site-stat-card">
                                        <div class="site-header">
                                            <h4>🏠 parrillalosnogales.com</h4>
                                            <span class="site-url">Sitio Principal</span>
                                        </div>
                                        <div class="site-metrics">
                                            <div class="metric-item">
                                                <strong>Total Visitas:</strong> ${parrillaStats.totalVisits}
                                            </div>
                                            <div class="metric-item">
                                                <strong>Visitantes Únicos:</strong> ${parrillaStats.uniqueVisitors}
                                            </div>
                                            <div class="metric-item">
                                                <strong>Hoy:</strong> ${parrillaStats.todayVisits}
                                            </div>
                                            <div class="metric-item">
                                                <strong>Esta Semana:</strong> ${parrillaStats.thisWeekVisits}
                                            </div>
                                            <div class="metric-item">
                                                <strong>Este Mes:</strong> ${parrillaStats.thisMonthVisits}
                                            </div>
                                            <div class="metric-item">
                                                <strong>Móviles:</strong> ${parrillaStats.mobileVisits} (${parrillaStats.mobilePercentage}%)
                                            </div>
                                            <div class="metric-item">
                                                <strong>Desktop:</strong> ${parrillaStats.desktopVisits} (${parrillaStats.desktopPercentage}%)
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="site-stat-card">
                                        <div class="site-header">
                                            <h4>📱 cartaonline.netlify.app</h4>
                                            <span class="site-url">Sitio Netlify</span>
                                        </div>
                                        <div class="site-metrics">
                                            <div class="metric-item">
                                                <strong>Total Visitas:</strong> ${netlifyStats.totalVisits}
                                            </div>
                                            <div class="metric-item">
                                                <strong>Visitantes Únicos:</strong> ${netlifyStats.uniqueVisitors}
                                            </div>
                                            <div class="metric-item">
                                                <strong>Hoy:</strong> ${netlifyStats.todayVisits}
                                            </div>
                                            <div class="metric-item">
                                                <strong>Esta Semana:</strong> ${netlifyStats.thisWeekVisits}
                                            </div>
                                            <div class="metric-item">
                                                <strong>Este Mes:</strong> ${netlifyStats.thisMonthVisits}
                                            </div>
                                            <div class="metric-item">
                                                <strong>Móviles:</strong> ${netlifyStats.mobileVisits} (${netlifyStats.mobilePercentage}%)
                                            </div>
                                            <div class="metric-item">
                                                <strong>Desktop:</strong> ${netlifyStats.desktopVisits} (${netlifyStats.desktopPercentage}%)
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        <div class="stats-details">
                            <div class="stats-section">
                                <h3>📊 Estadísticas por Período</h3>
                                <div class="period-stats">
                                    <div class="period-item">
                                        <strong>Hoy:</strong> ${stats.todayVisits} visitas
                                    </div>
                                    <div class="period-item">
                                        <strong>Ayer:</strong> ${stats.yesterdayVisits} visitas
                                    </div>
                                    <div class="period-item">
                                        <strong>Esta Semana:</strong> ${stats.thisWeekVisits} visitas
                                    </div>
                                    <div class="period-item">
                                        <strong>Semana Pasada:</strong> ${stats.lastWeekVisits} visitas
                                    </div>
                                    <div class="period-item">
                                        <strong>Este Mes:</strong> ${stats.thisMonthVisits} visitas
                                    </div>
                                    <div class="period-item">
                                        <strong>Mes Pasado:</strong> ${stats.lastMonthVisits} visitas
                                    </div>
                                    <div class="period-item">
                                        <strong>Este Año:</strong> ${stats.thisYearVisits} visitas
                                    </div>
                                </div>
                            </div>

                            <div class="stats-section">
                                <h3>📱 Dispositivos</h3>
                                <div class="device-stats">
                                    <div class="device-item">
                                        <strong>Móviles:</strong> ${stats.mobileVisits} (${stats.mobilePercentage}%)
                                    </div>
                                    <div class="device-item">
                                        <strong>Tablets:</strong> ${stats.tabletVisits} (${stats.tabletPercentage}%)
                                    </div>
                                    <div class="device-item">
                                        <strong>Desktop:</strong> ${stats.desktopVisits} (${stats.desktopPercentage}%)
                                    </div>
                                </div>
                            </div>

                            <div class="stats-section">
                                <h3>🌍 Origen del Tráfico</h3>
                                <div class="referrer-stats">
                                    ${Object.entries(stats.topReferrers).map(([referrer, count]) => `
                                        <div class="referrer-item">
                                            <strong>${referrer || 'Directo'}:</strong> ${count} visitas
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <div class="stats-section">
                                <h3>🕒 Horarios de Visita</h3>
                                <div class="hourly-stats">
                                    ${stats.hourlyDistribution.map((count, hour) => `
                                        <div class="hour-item">
                                            <strong>${hour}:00:</strong> ${count} visitas
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <div class="stats-section">
                                <h3>📅 Últimas Visitas por Sitio</h3>
                                <div class="recent-visits-container">
                                    <div class="recent-site-visits">
                                        <h4>🏠 parrillalosnogales.com</h4>
                                        <div class="recent-visits">
                                            ${parrillaVisits.slice(-5).reverse().map(visit => `
                                                <div class="visit-item">
                                                    <div class="visit-date">${new Date(visit.timestamp).toLocaleString()}</div>
                                                    <div class="visit-details">
                                                        <strong>Dispositivo:</strong> ${this.getDeviceType(visit.userAgent)} | 
                                                        <strong>Pantalla:</strong> ${visit.screenSize} | 
                                                        <strong>Idioma:</strong> ${visit.language}
                                                        ${visit.referrer ? `<br><strong>Origen:</strong> ${visit.referrer}` : ''}
                                                    </div>
                                                </div>
                                            `).join('')}
                                            ${parrillaVisits.length === 0 ? '<p style="text-align: center; color: #A6A6A6;">No hay visitas recientes</p>' : ''}
                                        </div>
                                    </div>
                                    
                                    <div class="recent-site-visits">
                                        <h4>📱 cartaonline.netlify.app</h4>
                                        <div class="recent-visits">
                                            ${netlifyVisits.slice(-5).reverse().map(visit => `
                                                <div class="visit-item">
                                                    <div class="visit-date">${new Date(visit.timestamp).toLocaleString()}</div>
                                                    <div class="visit-details">
                                                        <strong>Dispositivo:</strong> ${this.getDeviceType(visit.userAgent)} | 
                                                        <strong>Pantalla:</strong> ${visit.screenSize} | 
                                                        <strong>Idioma:</strong> ${visit.language}
                                                        ${visit.referrer ? `<br><strong>Origen:</strong> ${visit.referrer}` : ''}
                                                    </div>
                                                </div>
                                            `).join('')}
                                            ${netlifyVisits.length === 0 ? '<p style="text-align: center; color: #A6A6A6;">No hay visitas recientes</p>' : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="stats-actions">
                            <button onclick="app.exportStatistics()" class="btn btn-blue">
                                <i class="ph ph-download"></i> Exportar Estadísticas
                            </button>
                            <button onclick="app.clearStatistics()" class="btn btn-red">
                                <i class="ph ph-trash"></i> Limpiar Datos
                            </button>
                        </div>
                    </div>
                `;

                container.innerHTML = html;
                
                } catch (error) {
                    console.error('Error al cargar estadísticas:', error);
                    container.innerHTML = '<p style="text-align: center; color: #dc2626;">Error al cargar las estadísticas. Intenta nuevamente.</p>';
                }
            },

            calculateVisitStatistics(visits) {
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
                const weekStart = new Date(today.getTime() - today.getDay() * 24 * 60 * 60 * 1000);
                const lastWeekStart = new Date(weekStart.getTime() - 7 * 24 * 60 * 60 * 1000);
                const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                const lastMonthStart = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                const yearStart = new Date(now.getFullYear(), 0, 1);

                const stats = {
                    totalVisits: visits.length,
                    uniqueVisitors: this.getUniqueVisitors(visits),
                    todayVisits: 0,
                    yesterdayVisits: 0,
                    thisWeekVisits: 0,
                    lastWeekVisits: 0,
                    thisMonthVisits: 0,
                    lastMonthVisits: 0,
                    thisYearVisits: 0,
                    mobileVisits: 0,
                    tabletVisits: 0,
                    desktopVisits: 0,
                    topReferrers: {},
                    hourlyDistribution: new Array(24).fill(0)
                };

                visits.forEach(visit => {
                    const visitDate = new Date(visit.timestamp);
                    const visitHour = visitDate.getHours();

                    // Contar por período
                    if (visitDate >= today) stats.todayVisits++;
                    if (visitDate >= yesterday && visitDate < today) stats.yesterdayVisits++;
                    if (visitDate >= weekStart) stats.thisWeekVisits++;
                    if (visitDate >= lastWeekStart && visitDate < weekStart) stats.lastWeekVisits++;
                    if (visitDate >= monthStart) stats.thisMonthVisits++;
                    if (visitDate >= lastMonthStart && visitDate < monthStart) stats.lastMonthVisits++;
                    if (visitDate >= yearStart) stats.thisYearVisits++;

                    // Contar por dispositivo
                    const deviceType = this.getDeviceType(visit.userAgent);
                    if (deviceType === 'Móvil') stats.mobileVisits++;
                    else if (deviceType === 'Tablet') stats.tabletVisits++;
                    else stats.desktopVisits++;

                    // Contar referrers
                    const referrer = visit.referrer || 'Directo';
                    stats.topReferrers[referrer] = (stats.topReferrers[referrer] || 0) + 1;

                    // Distribución por hora
                    stats.hourlyDistribution[visitHour]++;
                });

                // Calcular porcentajes
                const totalDeviceVisits = stats.mobileVisits + stats.tabletVisits + stats.desktopVisits;
                stats.mobilePercentage = totalDeviceVisits > 0 ? Math.round((stats.mobileVisits / totalDeviceVisits) * 100) : 0;
                stats.tabletPercentage = totalDeviceVisits > 0 ? Math.round((stats.tabletVisits / totalDeviceVisits) * 100) : 0;
                stats.desktopPercentage = totalDeviceVisits > 0 ? Math.round((stats.desktopVisits / totalDeviceVisits) * 100) : 0;

                return stats;
            },

            getUniqueVisitors(visits) {
                // Usar una combinación de userAgent y screenSize como identificador único
                const uniqueIdentifiers = new Set();
                visits.forEach(visit => {
                    const identifier = `${visit.userAgent}_${visit.screenSize}`;
                    uniqueIdentifiers.add(identifier);
                });
                return uniqueIdentifiers.size;
            },

            getDeviceType(userAgent) {
                const mobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent);
                const tablet = /iPad|Android(?=.*\bMobile\b)(?=.*\bSafari\b)/i.test(userAgent);
                
                if (tablet) return 'Tablet';
                if (mobile) return 'Móvil';
                return 'Desktop';
            },

            async exportStatistics() {
                try {
                    this.showToast('📊 Exportando estadísticas...', 'info');
                    
                    // Cargar datos desde Firebase
                    const visitsSnapshot = await db.collection('websiteVisits')
                        .orderBy('createdAt', 'desc')
                        .limit(50000) // Exportar hasta 50,000 visitas
                        .get();
                    
                    const visits = visitsSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                        timestamp: doc.data().timestamp || doc.data().createdAt?.toDate?.()?.toISOString() || new Date().toISOString()
                    }));
                    
                    // Filtrar solo las 2 URLs específicas
                    const allowedUrls = [
                        'https://parrillalosnogales.com/',
                        'https://cartaonline.netlify.app/'
                    ];
                    
                    const filteredVisits = visits.filter(visit => {
                        const visitUrl = visit.url || '';
                        return allowedUrls.some(allowedUrl => visitUrl.includes(allowedUrl));
                    });
                    
                    if (filteredVisits.length === 0) {
                        this.showToast('❌ No hay datos para exportar de las URLs especificadas', 'error');
                        return;
                    }
                
                // Crear CSV
                let csv = 'Fecha,Hora,Sitio,Dispositivo,Pantalla,Idioma,Origen,URL\n';
                
                filteredVisits.forEach(visit => {
                    const date = new Date(visit.timestamp);
                    const deviceType = this.getDeviceType(visit.userAgent);
                    const referrer = visit.referrer || 'Directo';
                    
                    // Determinar qué sitio visitó
                    let sitio = 'Otro';
                    if ((visit.url || '').includes('parrillalosnogales.com')) {
                        sitio = 'parrillalosnogales.com';
                    } else if ((visit.url || '').includes('cartaonline.netlify.app')) {
                        sitio = 'cartaonline.netlify.app';
                    }
                    
                    csv += `"${date.toLocaleDateString()}","${date.toLocaleTimeString()}","${sitio}","${deviceType}","${visit.screenSize}","${visit.language}","${referrer}","${visit.url}"\n`;
                });

                // Descargar archivo
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `estadisticas_visitas_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                this.showToast('✅ Estadísticas exportadas correctamente', 'success');
                
                } catch (error) {
                    console.error('Error al exportar estadísticas:', error);
                    this.showToast('❌ Error al exportar estadísticas', 'error');
                }
            },

            async clearStatistics() {
                if (confirm('¿Estás seguro de que quieres eliminar todos los datos de estadísticas? Esta acción no se puede deshacer.')) {
                    try {
                        this.showToast('🗑️ Eliminando datos...', 'info');
                        
                        // Eliminar datos de Firebase
                        const visitsSnapshot = await db.collection('websiteVisits').get();
                        const batch = db.batch();
                        
                        visitsSnapshot.docs.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        
                        await batch.commit();
                        
                        // También limpiar localStorage
                        localStorage.removeItem('websiteVisits');
                        
                        this.loadStatistics();
                        this.showToast('✅ Todos los datos de estadísticas han sido eliminados', 'success');
                        
                    } catch (error) {
                        console.error('Error al eliminar estadísticas:', error);
                        this.showToast('❌ Error al eliminar estadísticas', 'error');
                    }
                }
            }
        };

        // Sistema de Fidelización para carta.html
        const loyaltySystem = {
            init() {
                this.setupAuthListener();
            },

            setupAuthListener() {
                // Configurar listener de autenticación
                firebase.auth().onAuthStateChanged(async (user) => {
                    if (user && user.emailVerified) {
                        await this.loadUserData(user.uid);
                        this.showLoyaltySection(true);
                    } else {
                        this.showLoyaltySection(false);
                    }
                });
            },

            async loadUserData(userId) {
                try {
                    const doc = await db.collection('users').doc(userId).get();
                    if (doc.exists) {
                        const userData = doc.data();
                        document.getElementById('loyalty-points').textContent = userData.points || 0;
                        this.updateDailyVisitButton(userData);
                    }
                } catch (error) {
                    console.error('Error cargando datos de usuario:', error);
                }
            },

            updateDailyVisitButton(userData) {
                const button = document.getElementById('daily-visit-btn');
                if (!userData) return;

                const today = new Date().toDateString();
                const lastVisit = userData.lastDailyVisit ? new Date(userData.lastDailyVisit.toDate()).toDateString() : null;
                const canClaim = !userData.dailyVisitClaimed && lastVisit !== today;

                if (canClaim) {
                    button.innerHTML = '<i class="ph-check-circle"></i> Reclamar Visita (+10 pts)';
                    button.disabled = false;
                } else {
                    button.innerHTML = '<i class="ph-clock"></i> Ya reclamaste hoy';
                    button.disabled = true;
                }
            },

            showLoyaltySection(isLoggedIn) {
                const loyaltySection = document.getElementById('loyalty-section');
                const loyaltyLoginSection = document.getElementById('loyalty-login-section');

                if (isLoggedIn) {
                    loyaltySection.classList.remove('loyalty-hidden');
                    loyaltyLoginSection.classList.add('loyalty-hidden');
                } else {
                    loyaltySection.classList.add('loyalty-hidden');
                    loyaltyLoginSection.classList.remove('loyalty-hidden');
                }
            },

            async claimDailyVisit() {
                try {
                    const user = firebase.auth().currentUser;
                    if (!user) {
                        alert('Debes iniciar sesión para reclamar puntos');
                        return;
                    }

                    const doc = await db.collection('users').doc(user.uid).get();
                    if (!doc.exists) {
                        alert('Usuario no encontrado');
                        return;
                    }

                    const userData = doc.data();
                    const today = new Date().toDateString();
                    const lastVisit = userData.lastDailyVisit ? new Date(userData.lastDailyVisit.toDate()).toDateString() : null;
                    
                    if (userData.dailyVisitClaimed && lastVisit === today) {
                        alert('Ya reclamaste los puntos de hoy');
                        return;
                    }

                    const pointsToAdd = 10;
                    const newPoints = (userData.points || 0) + pointsToAdd;

                    await db.collection('users').doc(user.uid).update({
                        points: newPoints,
                        totalPointsEarned: (userData.totalPointsEarned || 0) + pointsToAdd,
                        dailyVisitClaimed: true,
                        lastDailyVisit: new Date()
                    });

                    // Registrar transacción
                    await db.collection('pointTransactions').add({
                        userId: user.uid,
                        userEmail: userData.email,
                        userName: userData.name,
                        description: 'Visita diaria',
                        points: pointsToAdd,
                        type: 'earned',
                        timestamp: new Date(),
                        balanceAfter: newPoints
                    });

                    // Actualizar UI
                    document.getElementById('loyalty-points').textContent = newPoints;
                    this.updateDailyVisitButton({
                        ...userData,
                        points: newPoints,
                        dailyVisitClaimed: true,
                        lastDailyVisit: new Date()
                    });

                    alert(`¡+${pointsToAdd} puntos por tu visita!`);
                } catch (error) {
                    console.error('Error reclamando puntos:', error);
                    alert('Error al reclamar puntos');
                }
            }
        };

        // Inicializar sistema de fidelización
        loyaltySystem.init();

        // Función global para reclamar visita diaria
        window.claimDailyVisit = function() {
            loyaltySystem.claimDailyVisit();
        };

        app.init().catch(error => {
            console.error("Error al inicializar la aplicación:", error);
        });
    } catch (error) {
        console.error("❌ ERROR FATAL:", error);
        document.body.innerHTML = '<p style="color: red; font-family: sans-serif; padding: 20px;">Error Crítico. Revisa la consola (F12).</p>';
    }
</script>
</body>
</html>

